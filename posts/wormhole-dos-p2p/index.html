<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Wormhole's Guardian Network DoS through p2p vulnerability - MevSec</title><meta name=Description content="Second-Order DoS in Wormhole p2p"><meta property="og:title" content="Wormhole's Guardian Network DoS through p2p vulnerability"><meta property="og:description" content="Second-Order DoS in Wormhole p2p"><meta property="og:type" content="article"><meta property="og:url" content="/posts/wormhole-dos-p2p/"><meta property="og:image" content="/posts/wormhole-dos-p2p/wormholep2p.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-16T00:00:00+00:00"><meta property="article:modified_time" content="2024-04-16T00:00:00+00:00"><meta property="og:site_name" content="MevSec Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/posts/wormhole-dos-p2p/wormholep2p.png"><meta name=twitter:title content="Wormhole's Guardian Network DoS through p2p vulnerability"><meta name=twitter:description content="Second-Order DoS in Wormhole p2p"><meta name=application-name content="MevSec's blog"><meta name=apple-mobile-web-app-title content="MevSec's blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=/posts/wormhole-dos-p2p/><link rel=prev href=/posts/wormhole-ccq-rest-api-dos/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Wormhole's Guardian Network DoS through p2p vulnerability","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"\/posts\/wormhole-dos-p2p\/"},"image":[{"@type":"ImageObject","url":"\/posts\/wormhole-dos-p2p\/wormholep2p.png","width":1703,"height":512}],"genre":"posts","keywords":"Wormhole, p2p, DoS, Immunefi","wordcount":2127,"url":"\/posts\/wormhole-dos-p2p\/","datePublished":"2024-04-16T00:00:00+00:00","dateModified":"2024-04-16T00:00:00+00:00","publisher":{"@type":"Organization","name":"fadam"},"author":{"@type":"Person","name":"fadam"},"description":"Second-Order DoS in Wormhole p2p"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":""==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:""==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=MevSec>MevSec</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=MevSec>MevSec</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Wormhole's Guardian Network DoS through p2p vulnerability</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://blog.fadam.xyz/ title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>fadam</a></span>&nbsp;<span class=post-category>included in <a href=/categories/web2/><i class="far fa-folder fa-fw" aria-hidden=true></i>Web2</a>&nbsp;<a href=/categories/p2p/><i class="far fa-folder fa-fw" aria-hidden=true></i>p2p</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-04-16>2024-04-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2127 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;10 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-introduction>1. Introduction</a><ul><li><a href=#wormhole-and-guardians>Wormhole and Guardians</a></li><li><a href=#first-attempt-high-cardinality-attack>First attempt: High Cardinality Attack</a></li><li><a href=#second-attempt-timing-attack-leading-to-second-order-dos>Second attempt: Timing attack leading to Second Order DoS</a></li><li><a href=#conclusion>Conclusion</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=1-introduction>1. Introduction</h2><p>We discovered a vulnerability within the p2p implementation of Wormhole that would have allowed an external attacker to crash the Guardian network. The attack was non-volumetric, easy to reproduce, but difficult to catch. The difficulty came from the fact it was a <em>second-order attack</em>, meaning the hacker attacks the victim, but the exploit would be triggered by the victim itself at a later stage.</p><h3 id=wormhole-and-guardians>Wormhole and Guardians</h3><p>Wormhole uses a set of smart contracts in combination with a Guardian network to operate.
<img class=lazyload src=/svg/loading.min.svg data-src=/posts/wormhole-dos-p2p/1-Wormhole.png data-srcset="/posts/wormhole-dos-p2p/1-Wormhole.png, /posts/wormhole-dos-p2p/1-Wormhole.png 1.5x, /posts/wormhole-dos-p2p/1-Wormhole.png 2x" data-sizes=auto alt=/posts/wormhole-dos-p2p/1-Wormhole.png title="Wormhole Architecture" width=896 height=365></p><p>Guardians play a critical role for the functioning of Wormhole.
As per the documentation:</p><blockquote><p>Wormhole relies upon a set of distributed nodes that monitor the state on several blockchains. In Wormhole these nodes are referred to as Guardians. (&mldr;)
It is the Guardian&rsquo;s role to observe messages and sign the corresponding payloads. Each Guardian performs this step in isolation, later combining the resulting signatures with other Guardians as a final step.</p></blockquote><p>Guardians combine their results by communicating with each other through a p2p gossip network (based on the library <em>libp2p</em>).</p><p>Each actor on the p2p network is identified by a <strong>PeerId</strong>, determined by a private key that the node has generated. Guardians send broadcast messages on the gossip network, meaning everyone will receive them.
Other actors (<strong>Spies</strong>) can join the gossip network, and listen to the messages sent by the Guardians.
Those messages can be:</p><ul><li>Verified Action Approvals (VAA)</li><li>Observations</li><li><em>Heartbeats</em></li></ul><p>The primary role of the <strong>Spy</strong> is to catch the VAA and send them to <strong>Relayers</strong>, who will perform the interaction on the target chain.
Below is a schema that summarizes the different actors.
<img class=lazyload src=/svg/loading.min.svg data-src=/posts/wormhole-dos-p2p/2-p2p.png data-srcset="/posts/wormhole-dos-p2p/2-p2p.png, /posts/wormhole-dos-p2p/2-p2p.png 1.5x, /posts/wormhole-dos-p2p/2-p2p.png 2x" data-sizes=auto alt=/posts/wormhole-dos-p2p/2-p2p.png title="Wormhole p2p" width=590 height=410></p><p>We identified 2 interesting behaviours of the gossip p2p network:</p><ul><li><strong>Lack of access control</strong>: Not only Guardians can send messages. Anyone can send messages on gossip, even Spies, or any rogue client. Those messages will be interpreted by the Guardians.</li><li><strong>Lack of anti-replay mechanism</strong>: Anyone can replay <em>Heartbeats</em>: Guardians will not check if they have already received a message.</li></ul><p>From here we tried to use these facts to see if we could crash the p2p network.</p><h3 id=first-attempt-high-cardinality-attack>First attempt: High Cardinality Attack</h3><p>With the previous information we tried to find attack vectors. The first promising one was <strong>High-Cardinality Attacks.</strong> You can check <a href=https://github.com/open-telemetry/opentelemetry-go-contrib/security/advisories/GHSA-5r5m-65gx-7vrh target=_blank rel="noopener noreffer">this vulnerability</a> for reference.
Those attacks occur when an external attacker can add lots of lines in the Prometheus metrics, increasing CPU/RAM consumption.</p><p>As mentioned <a href=https://last9.io/blog/how-to-manage-high-cardinality-metrics-in-prometheus/ target=_blank rel="noopener noreffer">here</a> :</p><blockquote><p>This can have implications for the performance and scalability of Prometheus, as each distinct label combination creates a separate time series in the system. A high cardinality can increase memory usage, CPU usage, longer query times, and higher storage requirements.</p></blockquote><p>Because the information of the p2p <em>PeerId</em> is random (depends on a generated secret key), and because the information about the <em>PeerId</em> is added in the metrics when a message is replayed, an external attacker can perform the attack by replaying old messages with a rogue client, and regularly change his <em>PeerId</em>. Because each Guardian listens to the p2p, this would impact all Guardians at the same time.</p><p>To go into details in the code:
In the p2p.go file, there is a <strong>Switch Case</strong> that deals with received messages by Guardians.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=k>switch</span> <span class=nx>m</span> <span class=o>:=</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Message</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=o>*</span><span class=nx>gossipv1</span><span class=p>.</span><span class=nx>GossipMessage_SignedHeartbeat</span><span class=p>:</span>  
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=o>*</span><span class=nx>gossipv1</span><span class=p>.</span><span class=nx>GossipMessage_SignedObservation</span><span class=p>:</span>  
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=o>*</span><span class=nx>gossipv1</span><span class=p>.</span><span class=nx>GossipMessage_SignedVaaWithQuorum</span><span class=p>:</span>  
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=o>*</span><span class=nx>gossipv1</span><span class=p>.</span><span class=nx>GossipMessage_SignedObservationRequest</span><span class=p>:</span>  
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=o>*</span><span class=nx>gossipv1</span><span class=p>.</span><span class=nx>GossipMessage_SignedChainGovernorConfig</span><span class=p>:</span>  
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=o>*</span><span class=nx>gossipv1</span><span class=p>.</span><span class=nx>GossipMessage_SignedChainGovernorConfig</span><span class=p>:</span>  
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>default</span><span class=p>:</span>  
</span></span></code></pre></td></tr></table></div></div><p>If we take the example of <code>GossipMessage_SignedHeartbeat</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=k>case</span> <span class=o>*</span><span class=nx>gossipv1</span><span class=p>.</span><span class=nx>GossipMessage_SignedHeartbeat</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>Heartbeat</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>processSignedHeartbeat</span><span class=p>(</span><span class=nx>envelope</span><span class=p>.</span><span class=nf>GetFrom</span><span class=p>(),</span> <span class=nx>s</span><span class=p>,</span> <span class=nx>gs</span><span class=p>,</span> <span class=nx>gst</span><span class=p>,</span> <span class=nx>disableHeartbeatVerify</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span></code></pre></td></tr></table></div></div><p>The function that will treat the <em>Heartbeat</em> is <code>processSignedHeartbeat()</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>processSignedHeartbeat</span><span class=p>(</span><span class=nx>from</span> <span class=nx>peer</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=nx>s</span> <span class=o>*</span><span class=nx>gossipv1</span><span class=p>.</span><span class=nx>SignedHeartbeat</span><span class=p>,</span> <span class=nx>gs</span> <span class=o>*</span><span class=nx>common</span><span class=p>.</span><span class=nx>GuardianSet</span><span class=p>,</span> <span class=nx>gst</span> <span class=o>*</span><span class=nx>common</span><span class=p>.</span><span class=nx>GuardianSetState</span><span class=p>,</span> <span class=nx>disableVerify</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>gossipv1</span><span class=p>.</span><span class=nx>Heartbeat</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>collectNodeMetrics</span><span class=p>(</span><span class=nx>signerAddr</span><span class=p>,</span> <span class=nx>from</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>h</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=o>&amp;</span><span class=nx>h</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span> 
</span></span></code></pre></td></tr></table></div></div><p>In the end, the function <code>collectNodeMetrics(signerAddr, **from**, &amp;h)</code> will update the metrics, with the <em>PeerId</em> that was given by the attacker.</p><p>The actual sender (p2p node) is <strong>from</strong>, which is a <em>PeerId</em> defined by its private key. This information is never checked within the function to ensure the <em>PeerId</em> is legitimate, meaning checking if it matches the real <em>PeerId</em> of the guardian having sent the <em>Heartbeat</em> <strong>h</strong>.</p><p>An external attacker can therefore:</p><ol><li>Join the p2p network with a rogue client,</li><li>Replays <em>Heartbeats</em>,</li><li>Change their <em>PeerId</em> by recreating a secret key,</li><li>Go back to Step 1</li></ol><p>By doing so, this will add metrics and the table will grow in size (+150/200 lines in the metrics for each new <em>PeerId</em>) because the new <em>PeerId</em> will be associated with all the metrics (different blockchains, versions, etc). Also, because of the p2p infrastructure, the rogue messages will be treated by the others Guardians that did not send the message, amplifying the attack. This could theoretically lead to a Denial-of-Service by filling up the disk of guardian nodes.</p><p>We can see that cardinality attack is a concern for Wormhole in multiple places through the code, for example <code>node/pkg/p2p/netmetrics.go</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// sanitizeVersion cleans up the version string to prevent an attacker from executing a cardinality attack.
</span></span></span></code></pre></td></tr></table></div></div><p>Or again in the <code>node/pkg/processor/observation.go</code> file :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// We can now count events by Guardian without worry about cardinality explosions:
</span></span></span></code></pre></td></tr></table></div></div><p>We were able to produce a PoC that we shared with the Wormhole team, but there were many issues:</p><ul><li>The test environment provided by Wormhole (Tilt) consumes a lot of CPU, making our test inconclusive according to the team,</li><li>The attack was very slow, meaning it could have needed volume to succeed, which would have made it categorized as a &ldquo;Volumetric attack&rdquo;, which is out-of-scope,</li><li>Our PoC was inefficient because it used a modified Spy.</li><li>The Prometheus client library used by the guardian nodes does not store metrics on disk. A restart of a guardian node clears out the metrics.</li></ul><p>Due to the above issues, they wanted a better PoC where they could see the Guardians failing at their task (not seeing <em>Heartbeats</em> or observations). After discussing, they sent us <a href=https://github.com/wormhole-foundation/wormhole-dashboard/blob/main/fly/cmd/healthcheck/main.go target=_blank rel="noopener noreffer">this file</a> to monitor this part.</p><p>After analysis of this file, we realized that:</p><ul><li>It was unsure to be suited in our case, because it monitors <em>Heartbeats</em> while we mess up <em>Heartbeats</em>.</li><li>It could be very useful for something else : it would allow us to write a better PoC for the vulnerability. Indeed, this file contains a &ldquo;simple client&rdquo; joining the gossip, while our tests were from a heavily modified Spy.</li></ul><p>After having rewritten the PoC, we could see CPU/RAM consumption increasing, but nothing significant in a short period of time.
Sometimes, we would see a Guardian restarting, <strong>we did not pay attention for a few days</strong>, this was actually the source of a bigger issue. We were so &ldquo;focused&rdquo; on the Cardinality Attack that we forgot to look at this &ldquo;detail&rdquo;. Typical mistake.</p><p>After having spent some time on this attack without success, we finally decided to look at why the Guardians would sometimes restart.</p><h3 id=second-attempt-timing-attack-leading-to-second-order-dos>Second attempt: Timing attack leading to Second Order DoS</h3><p>After having randomly reproduced a crash, we looked at the message:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=nx>panic</span><span class=p>:</span> <span class=nx>too</span> <span class=nx>many</span> <span class=nx>nodes</span> <span class=mi>15</span> <span class=k>for</span> <span class=nx>Guardian</span><span class=p>,</span> <span class=nx>cannot</span> <span class=nx>store</span> <span class=nx>entry</span>
</span></span></code></pre></td></tr></table></div></div><p>When a node sends a <em>Heartbeat</em>, there is this logic:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gst</span><span class=p>.</span><span class=nf>SetHeartbeat</span><span class=p>(</span><span class=nx>ourAddr</span><span class=p>,</span> <span class=nx>h</span><span class=p>.</span><span class=nf>ID</span><span class=p>(),</span> <span class=nx>Heartbeat</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Here is the function <code>SetHeartbeat()</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>const</span> <span class=nx>MaxNodesPerGuardian</span> <span class=p>=</span> <span class=mi>15</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SetHeartbeat stores a verified heartbeat observed by a given Guardian.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>st</span> <span class=o>*</span><span class=nx>GuardianSetState</span><span class=p>)</span> <span class=nf>SetHeartbeat</span><span class=p>(</span><span class=nx>addr</span> <span class=nx>common</span><span class=p>.</span><span class=nx>Address</span><span class=p>,</span> <span class=nx>peerId</span> <span class=nx>peer</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=nx>hb</span> <span class=o>*</span><span class=nx>gossipv1</span><span class=p>.</span><span class=nx>Heartbeat</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>st</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>st</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>v</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>st</span><span class=p>.</span><span class=nx>lastHeartbeats</span><span class=p>[</span><span class=nx>addr</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>v</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>peer</span><span class=p>.</span><span class=nx>ID</span><span class=p>]</span><span class=o>*</span><span class=nx>gossipv1</span><span class=p>.</span><span class=nx>Heartbeat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>st</span><span class=p>.</span><span class=nx>lastHeartbeats</span><span class=p>[</span><span class=nx>addr</span><span class=p>]</span> <span class=p>=</span> <span class=nx>v</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=nx>MaxNodesPerGuardian</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// TODO: age out old entries?
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;too many nodes (%d) for Guardian, cannot store entry&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>v</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>v</span><span class=p>[</span><span class=nx>peerId</span><span class=p>]</span> <span class=p>=</span> <span class=nx>hb</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>st</span><span class=p>.</span><span class=nx>updateC</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>st</span><span class=p>.</span><span class=nx>updateC</span> <span class=o>&lt;-</span> <span class=nx>hb</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>On each Guardian, there is one <strong>v</strong> mapping per known Guardian, including one <strong>v</strong> mapping for himself.</p><p>The <strong>v</strong> mappings contain a list of associated: <strong>PeerId</strong> &lt;-> <em>Heartbeat</em></p><p>Also, before sending a <em>Heartbeat</em>, a Guardian checks that the <strong>v</strong> mapping for himself does not have more than 15 <em>Heartbeats</em> coming from more than 15 <strong>PeerIds</strong>. In case it fails, it reaches the <strong>panic</strong>.</p><p>This mapping is cleaned every minute with a <code>Cleanup()</code> function.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// Cleanup removes expired entries from the state.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>st</span> <span class=o>*</span><span class=nx>GuardianSetState</span><span class=p>)</span> <span class=nf>Cleanup</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>st</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>st</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>addr</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>st</span><span class=p>.</span><span class=nx>lastHeartbeats</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>peerId</span><span class=p>,</span> <span class=nx>hb</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>v</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ts</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Unix</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>hb</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>ts</span><span class=p>)</span> <span class=p>&gt;</span> <span class=nx>MaxStateAge</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nb>delete</span><span class=p>(</span><span class=nx>st</span><span class=p>.</span><span class=nx>lastHeartbeats</span><span class=p>[</span><span class=nx>addr</span><span class=p>],</span> <span class=nx>peerId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This mapping is also updated when a Guardian receives a <em>Heartbeat</em>, where an attacker can add entries by replaying <em>Heartbeats</em> with a different <strong>PeerId</strong>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>processSignedHeartbeat</span><span class=p>(</span><span class=nx>from</span> <span class=nx>peer</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=nx>s</span> <span class=o>*</span><span class=nx>gossipv1</span><span class=p>.</span><span class=nx>SignedHeartbeat</span><span class=p>,</span> <span class=nx>gs</span> <span class=o>*</span><span class=nx>common</span><span class=p>.</span><span class=nx>GuardianSet</span><span class=p>,</span> <span class=nx>gst</span> <span class=o>*</span><span class=nx>common</span><span class=p>.</span><span class=nx>GuardianSetState</span><span class=p>,</span> <span class=nx>disableVerify</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>gossipv1</span><span class=p>.</span><span class=nx>Heartbeat</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// Store verified heartbeat in global Guardian set state.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gst</span><span class=p>.</span><span class=nf>SetHeartbeat</span><span class=p>(</span><span class=nx>signerAddr</span><span class=p>,</span> <span class=nx>from</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>h</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to store in Guardian set state: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>By replaying <em>Heartbeats</em> with different <em>PeerId</em>, our initial attack would fill the <em>v</em> mapping without us realizing it. Also, because of the cleanup mechanism that removes the structure every minute, the probability that we would trigger the crash was low but still existing.</p><p>It is however possible to crash the Guardians with proper timing.
The schema below describes the attack :
<img class=lazyload src=/svg/loading.min.svg data-src=/posts/wormhole-dos-p2p/3-attack.png data-srcset="/posts/wormhole-dos-p2p/3-attack.png, /posts/wormhole-dos-p2p/3-attack.png 1.5x, /posts/wormhole-dos-p2p/3-attack.png 2x" data-sizes=auto alt=/posts/wormhole-dos-p2p/3-attack.png title=Attack width=610 height=577></p><p>The steps are:</p><ol><li>Connecting 20 clients on the p2p with different <em>PeerId</em>.</li><li>When a <em>Heartbeat</em> is received, we wait 10 seconds. Because the panic occurs when the Guardian wants to send <em>Heartbeats</em>, and because there is a cleanup mechanism, we are more efficient if we attack right before the next <em>Heartbeat</em> (which is every 15 seconds).</li><li>Send 20 <em>Heartbeats</em> to the gossip from the 20 <em>PeerId</em> (1 <em>Heartbeat</em> per <em>PeerId</em>). This will pollute <em>v</em> to the limit (15 entries).</li><li>When the Guardian wants to send its <em>Heartbeat</em>, it will cause a panic because <em>v</em> is full, and a restart of the Guardian will occur</li></ol><p>Attack is:</p><ul><li>Not volumetric: A <em>Heartbeat</em> is around 1.7Kb. 20 <em>Heartbeats</em> (&lt;40kb) to crash most Guardians,</li><li>Easily repeatable,</li><li>Fast to crash the Guardians (less than 2 minutes on our testbed)</li><li>Impacts the bootstrap nodes: <strong>If the bootstrap nodes are down, other crashed nodes will not be able to join the network again</strong></li></ul><p><strong>The attack was very successful</strong>. For <strong>n</strong> Guardians, we would crash <strong>n-1</strong> Guardians in less than 2 minutes.</p><p>The code of the PoC can be found <a href=https://gist.github.com/0xfadam/81b73e34e4ca32770c80f80236db1e81 target=_blank rel="noopener noreffer">on Github</a></p><p>Here are some videos PoC with 4 Guardians, and the attack started from a Spy:</p><ol><li><p><a href="https://drive.google.com/file/d/108dCxPForlYZfLgUDp-0pgdXAKaMVK7k/view?usp=sharing" target=_blank rel="noopener noreffer">Crash of nodes bootstrap, 2 and 3</a> ; About the video:</p><ul><li>0.00: Happy situation, all 4 Guardians receive <em>Heartbeats</em> from each other</li><li>0.36: Our attacker starts replaying <em>Heartbeats</em></li><li>0.54: Crash of node 0</li><li>1.00: Crash of node 2</li><li>1.15: Crash of node 3</li><li>1.53: We filter to see which nodes crashed</li></ul></li><li><p><a href="https://drive.google.com/file/d/1eNRFBhM493anV_twxX0V7XbxU7_O8fYy/view?usp=sharing" target=_blank rel="noopener noreffer">Crash of nodes 1, 2 and 3</a> ; About the video:</p><ul><li>0.00: Happy situation, all 4 Guardians receive <em>Heartbeats</em> from each other</li><li>0.38: Our attacker starts replaying <em>Heartbeats</em></li><li>0.53: Crash of node 3</li><li>1.08: Crash of nodes 1 and 2</li></ul></li></ol><h3 id=conclusion>Conclusion</h3><p>The issue was fixed in <a href=https://github.com/wormhole-foundation/wormhole/pull/3873 target=_blank rel="noopener noreffer">PR3873</a>.
When receiving a <em>Heartbeat</em>, the code now ensures that the <strong>PeerId</strong> of the p2p message matches the <strong>PeerId</strong> of the Guardian who generated the <em>Heartbeat</em>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl>	<span class=c1>// Don&#39;t accept replayed heartbeats from other peers
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>signedPeer</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>peer</span><span class=p>.</span><span class=nf>IDFromBytes</span><span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>P2PNodeId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to decode peer ID from bytes: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>signedPeer</span> <span class=o>!=</span> <span class=nx>from</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;guardian signed peer does not match sending peer&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>In this case, the attack was difficult to catch because the vulnerability was of <em>second-order</em>: The attacker performs his action, but the vulnerability will be triggered when the impacted component performs a separate action. The <code>Cleanup()</code> function was also making the vulnerability more difficult to identify.</p><p>Beyond Wormhole, we have looked at p2p networks recently, and noticed that they are difficult to exploit :</p><ul><li>Attack surface is reduced: auditors will very often land in a &ldquo;Switch case&rdquo; logic, with a &ldquo;default&rdquo; case that ignores malformed messages,</li><li>Messages are limited in size (2Kb in Wormhole&rsquo;s case), reducing the possibility of creating payload,</li><li>Frequently, rogue nodes cannot send valid messages because signature verification will be made, leaving us mostly with the possibility of replaying messages.</li></ul><p>However, when a vulnerability is found on the p2p, it usually is of high impact because it will impact all nodes listening to the p2p.
We have the strong conviction that whitehats are not done finding bugs in Blockchain p2p infrastructure.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-04-16</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/wormhole/>Wormhole</a>,&nbsp;<a href=/tags/p2p/>p2p</a>,&nbsp;<a href=/tags/dos/>DoS</a>,&nbsp;<a href=/tags/immunefi/>immunefi</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/wormhole-ccq-rest-api-dos/ class=prev rel=prev title="Taking down Wormhole's CCQ service through REST API"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Taking down Wormhole's CCQ service through REST API</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.119.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:500},comment:{},lightgallery:!0,search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>